<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Re-learning Vim (4) | Goofing Osamu</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    
  </head>

  <body>
    <nav>
    <ul class="menu">
      
      <li><a href="/">Home</a></li>
      
      <li><a href="/about/">About</a></li>
      
      <li><a href="/categories/">Categories</a></li>
      
      <li><a href="/tags/">Tags</a></li>
      
      <li><a href="/en/">English</a></li>
      
      <li><a href="/jp/">Japanese</a></li>
      
      <li><a href="/index.xml">Subscribe</a></li>
      
    </ul>
    <hr/>
    </nav>

<div class="article-meta">
<h1><span class="title">Re-learning Vim (4)</span></h1>

<h3 class="date">Date:
2022/07/15 (initial publish),
2022/07/24 (last update)
</h3>
</div>

<main>


<table width="100%">
  <tbody>
  <tr>
  
  <td align="left" width="33%"><a href="/en/2022/05/27/dgit-cheatsheet01/">Previous Post</a></td>
  
  <td align="center" width="33%"><a href="/en/">Top</a></td>
  
  <td align="right" width="33%"><a href="#">***</a></td>
  
  </tr>
  </tbody>
</table>

<h2>TOC</h2>

<nav id="TableOfContents">
  <ul>
    <li><a href="#neovim-07-migration">Neovim 0.7 migration</a></li>
    <li><a href="#syntax-checker">Syntax checker</a></li>
    <li><a href="#internals-of-astronvim">Internals of AstroNvim</a>
      <ul>
        <li><a href="#prerequisite">Prerequisite</a></li>
        <li><a href="#value-of-vim-option-and-runtimepath">Value of vim option and <code>runtimepath</code></a></li>
        <li><a href="#tracing-source-code-of-astronvim-with-single-configastronvimuserinitlua">Tracing source code of AstroNvim with single <code>~/.config/astronvim/user/init.lua</code></a></li>
        <li><a href="#entry-point-initlua">Entry point: <code>init.lua</code></a></li>
        <li><a href="#variable-astronvim">Variable <code>astronvim</code></a></li>
        <li><a href="#function-conditional_func">Function: <code>conditional_func</code></a></li>
        <li><a href="#function-user_plugin_opts-in-confignviminitlua">Function: <code>user_plugin_opts</code> in <code>~/.config/nvim/init.lua</code></a></li>
        <li><a href="#3-local-functions-used-by-user_plugin_opts">3 local functions used by <code>user_plugin_opts</code></a></li>
        <li><a href="#other-user_plugin_opts">other <code>user_plugin_opts</code></a></li>
      </ul>
    </li>
    <li><a href="#customization">Customization</a></li>
    <li><a href="#lazygit">Lazygit</a></li>
    <li><a href="#modifier-keys">Modifier keys</a></li>
    <li><a href="#paste-mode">Paste mode</a></li>
  </ul>
</nav>

<h2 id="neovim-07-migration">Neovim 0.7 migration</h2>
<p>After short trial of <strong>Neovim</strong> (nvim) 0.5 described in <a href="/en/2021/09/12/vim-learn-3/">Re-learning Vim
(3)</a>, I went back to the good old <strong>Vim</strong> with
ALE.</p>
<p>As I find out <a href="https://neovim.io/">Neovim</a> (nvim) 0.7 now has native LSP
support and tools around it seems to be getting mature, I decided to check nvim
with lua again. I also found a nice recent review:</p>
<ul>
<li><a href="https://galexbh.hashnode.dev/the-best-ide-style-configurations-for-nvim">The best IDE-style configurations for nvim</a></li>
</ul>
<p>Then I checked code size etc on IDE system:</p>
<ul>
<li>DOOM-NVIM (572K effective code)
<ul>
<li>SRC: <a href="https://github.com/NTBBloodbath/doom-nvim">https://github.com/NTBBloodbath/doom-nvim</a></li>
</ul>
</li>
<li>LunarVim (452K effective code)
<ul>
<li>SRC: <a href="https://github.com/LunarVim/LunarVim">https://github.com/LunarVim/LunarVim</a></li>
<li>HOME: <a href="https://www.lunarvim.org/#opinionated">https://www.lunarvim.org/#opinionated</a></li>
</ul>
</li>
<li>AstroNvim (316K effective code)
<ul>
<li>SRC: <a href="https://github.com/AstroNvim/AstroNvim">https://github.com/AstroNvim/AstroNvim</a></li>
<li>HOME: <a href="https://astronvim.github.io/">https://astronvim.github.io/</a></li>
</ul>
</li>
<li>NvChad (108K effective code)
<ul>
<li>SRC: <a href="https://github.com/NvChad/NvChad">https://github.com/NvChad/NvChad</a></li>
<li>WIKI: <a href="https://github.com/NvChad/NvChad/wiki">https://github.com/NvChad/NvChad/wiki</a> (old)</li>
<li>HOME: <a href="https://nvchad.netlify.app/">https://nvchad.netlify.app/</a></li>
</ul>
</li>
</ul>
<p>Since AstroNvim seems to be most interesting for its compactness and
pre-configured package settings, I tried it as the main <code>nvim</code> configuration.
I also installed LunarVim since it creates the <code>lvim</code> command which doesn&rsquo;t
interfere with the normal <code>nvim</code> execution.  These can co-exist.</p>
<p>All these already use delayed loading etc., to save their start up time.  That
is not what I am focused any more.  My focus is now the out-of-box usability
and the ease of configuration.</p>
<h2 id="syntax-checker">Syntax checker</h2>
<p>If I install <code>shellcheck</code>, both AstroNvim and LunarVim display error messages.
Nice out of box configuration.</p>
<h2 id="internals-of-astronvim">Internals of AstroNvim</h2>
<p>Let me record how I looked into the internals of AstroNvim for its user
configuration.</p>
<h3 id="prerequisite">Prerequisite</h3>
<p>See <a href="https://github.com/nanotee/nvim-lua-guide">Getting started using Lua in
Neovim</a> and its linked documents
first.</p>
<h3 id="value-of-vim-option-and-runtimepath">Value of vim option and <code>runtimepath</code></h3>
<p>We can inspect the actual internal option value of running nvim from the nvim
command mode.  The actual vim <code>runtimepath</code> option from lua&rsquo;s point of view can
be inspected by:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>:lua print(vim.inspect(vim.opt.runtimepath))
</span></span></code></pre></div><p>It is impossible to read so much output and make any sense.  Here, <code>:redir</code> can
be used to ease reading of these by capturing output in a file. (The use of
<code>:silent</code> kills pager prompt.)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>:redir <span style="color:#f92672">&gt;</span> rtp.txt
</span></span><span style="display:flex;"><span>:silent lua print(vim.inspect(vim.opt.runtimepath))
</span></span><span style="display:flex;"><span>:redir END
</span></span></code></pre></div><p>Now we know <code>scope = &quot;global&quot;</code>, <code>shortname = &quot;rtp&quot;</code>, etc.  We can always use
short name, too.</p>
<p>If we need its current value only,  it can be inspected and presented in lua
table by:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>:lua print(vim.inspect(vim.opt.rtp:get()))
</span></span></code></pre></div><p>Alternatively since we now know it is a global option, it can be accessed and
presented in similar way as vim classic <code>:set rtp?</code> style by:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>:lua print(vim.go.rtp)
</span></span></code></pre></div><p>From this output, we can confirm <code>rtp</code> to be scanned roughly as follows.</p>
<ul>
<li><code>/home/&lt;username&gt;/.config/nvim</code></li>
<li><code>/home/&lt;username&gt;/.local/share/nvim/site/pack/packer/opt/*</code></li>
<li><code>/home/&lt;username&gt;/.local/share/nvim/site/pack/packer/opt/*/after</code></li>
<li><code>/home/&lt;username&gt;/.config/nvim/after</code></li>
<li><code>/home/&lt;username&gt;/.config/astronvim</code></li>
</ul>
<p>The notable point is the last one specially inserted by AstroNvim.</p>
<p>This allows us to move <code>lua/user/</code> directory out of <code>~/config/nvim</code> to
<code>~/config/astronvim</code>.</p>
<h3 id="tracing-source-code-of-astronvim-with-single-configastronvimuserinitlua">Tracing source code of AstroNvim with single <code>~/.config/astronvim/user/init.lua</code></h3>
<p>Let&rsquo;s try to trace source code of AstroNvim to understand how to customize it.</p>
<p>Let me first assume there is a user configuration file at
<code>~/.config/astronvim/user/init.lua</code> for simplicity.</p>
<ul>
<li><a href="https://astronvim.github.io/configuration/basic_configuration">Basic Configuration</a></li>
</ul>
<h3 id="entry-point-initlua">Entry point: <code>init.lua</code></h3>
<p>The entry point of nvim is <code>/home/&lt;username&gt;/.config/nvim/init.lua</code>.  It is
simply as:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#66d9ef">local</span> impatient_ok, impatient <span style="color:#f92672">=</span> pcall(require, <span style="color:#e6db74">&#34;impatient&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> impatient_ok <span style="color:#66d9ef">then</span> impatient.enable_profile() <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> _, source <span style="color:#66d9ef">in</span> ipairs {
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;core.utils&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;core.options&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;core.bootstrap&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;core.plugins&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;core.autocmds&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;core.mappings&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;core.ui&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;configs.which-key-register&#34;</span>,
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">local</span> status_ok, fault <span style="color:#f92672">=</span> pcall(require, source)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> status_ok <span style="color:#66d9ef">then</span> vim.api.nvim_err_writeln(<span style="color:#e6db74">&#34;Failed to load &#34;</span> <span style="color:#f92672">..</span> source <span style="color:#f92672">..</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n\n</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">..</span> fault) <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>astronvim.conditional_func(astronvim.user_plugin_opts(<span style="color:#e6db74">&#34;polish&#34;</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">false</span>))
</span></span></code></pre></div><p>The first few lines are for
<a href="https://github.com/lewis6991/impatient.nvim.git">impatient.nvim</a> package.  Its
one of the package installed in
<code>/home/&lt;username&gt;/.local/share/nvim/site/pack/packer/start/</code> together with
<a href="https://github.com/wbthomason/packer.nvim">packer.nvim</a> and
<a href="https://github.com/nvim-lua/popup.nvim.git">popup.nvim</a>.  These are loaded
automatically upon starting nvim.</p>
<p><code>impatient.nvim</code> speeds up loading Lua modules in Neovim to improve startup time.</p>
<p>Then loop over <code>source</code> to set up AstroNvim&rsquo;s upstream configured system.
We will get back to these.</p>
<p>The last line is entry point for the user configuration.  So we need to find
out followings:</p>
<ul>
<li>Variable: <code>astronvim</code></li>
<li>Function: <code>conditional_func</code></li>
<li>Function: <code>user_plugin_opts</code></li>
</ul>
<h3 id="variable-astronvim">Variable <code>astronvim</code></h3>
<p>The <code>astronvim</code> is the globally accessible variable within AstroNvim
defined originally in <code>utils/init.lua</code> as:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>_G.astronvim <span style="color:#f92672">=</span> {}
</span></span></code></pre></div><p>We can inspect its current value as:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>:lua print(vim.inspect(astronvim))
</span></span></code></pre></div><p>(It is too big to paste here but it is full of important informaion)</p>
<h3 id="function-conditional_func">Function: <code>conditional_func</code></h3>
<p>This is a simple function defined in <code>lua/core/utils/init.lua</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">astronvim</span>.<span style="color:#a6e22e">conditional_func</span>(func, condition, ...)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (condition <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">and</span> <span style="color:#66d9ef">true</span> <span style="color:#f92672">or</span> condition) <span style="color:#f92672">and</span> type(func) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;function&#34;</span> <span style="color:#66d9ef">then</span> <span style="color:#66d9ef">return</span> func(...) <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span></code></pre></div><ul>
<li>If <code>condition</code> is not specified, and if <code>func</code> is the function type, return <code>func(...)</code>.</li>
<li>If <code>condition</code> exists and is met, and if <code>func</code> is the function type, return <code>func(...)</code>.</li>
</ul>
<p>The above case is, <code>condition</code>=<code>nil</code> and <code>...</code> is <code>nil</code>.
So this simply calls <code>astrovim.user_plugin_opts(&quot;polish&quot;, nil, false)</code> at the
end of the nvim start up.</p>
<h3 id="function-user_plugin_opts-in-confignviminitlua">Function: <code>user_plugin_opts</code> in <code>~/.config/nvim/init.lua</code></h3>
<p>This is a function defined in <code>lua/core/utils/init.lua</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">astronvim</span>.<span style="color:#a6e22e">user_plugin_opts</span>(module, default, extend, prefix)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> extend <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> <span style="color:#66d9ef">then</span> extend <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span> <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>  default <span style="color:#f92672">=</span> default <span style="color:#f92672">or</span> {}
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">local</span> user_settings <span style="color:#f92672">=</span> load_module_file((prefix <span style="color:#f92672">or</span> <span style="color:#e6db74">&#34;user&#34;</span>) <span style="color:#f92672">..</span> <span style="color:#e6db74">&#34;.&#34;</span> <span style="color:#f92672">..</span> module)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> user_settings <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">and</span> prefix <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> <span style="color:#66d9ef">then</span> user_settings <span style="color:#f92672">=</span> user_setting_table(module) <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> user_settings <span style="color:#f92672">~=</span> <span style="color:#66d9ef">nil</span> <span style="color:#66d9ef">then</span> default <span style="color:#f92672">=</span> func_or_extend(user_settings, default, extend) <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> default
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>Since in <code>lua/core/utils/init.lua</code>, following values are used.</p>
<ul>
<li><code>module=&quot;polish&quot;</code></li>
<li><code>default=nil</code></li>
<li><code>extend=false</code></li>
<li><code>prefix=nil</code></li>
</ul>
<p>Thus, this function processes essentially as:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>  module<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;polish&#34;</span>
</span></span><span style="display:flex;"><span>  default <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>  extend<span style="color:#f92672">=</span><span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>  prefix<span style="color:#f92672">=</span><span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">local</span> user_settings <span style="color:#f92672">=</span> load_module_file(<span style="color:#e6db74">&#34;user.polish&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">-- nil with ~/.config/astrovim/lua/usr/init.lua only configuration</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> user_settings <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> <span style="color:#66d9ef">then</span> user_settings <span style="color:#f92672">=</span> user_setting_table(<span style="color:#e6db74">&#34;polish&#34;</span>) <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">-- load ~/.config/astrovim/lua/usr/init.lua and return &#34;polish&#34; as</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">-- user_settings with some tricks</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> user_settings <span style="color:#f92672">~=</span> <span style="color:#66d9ef">nil</span> <span style="color:#66d9ef">then</span> default <span style="color:#f92672">=</span> func_or_extend(user_settings, {} , <span style="color:#66d9ef">false</span>) <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">-- update default by user_settings in polish </span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> default
</span></span></code></pre></div><p>So essentially, if <code>lua/core/utils/init.lua</code> is given, its <code>polish</code> function
seems to be executed. with some tricks.  (Of courese, 3 local functions used by
<code>user_plugin_opts</code> needs to be examined carefully as follows to come to this
conclusion.)</p>
<h3 id="3-local-functions-used-by-user_plugin_opts">3 local functions used by <code>user_plugin_opts</code></h3>
<p>Let&rsquo;s understand 3 local functions used by <code>user_plugin_opts</code> in
<code>lua/core/utils/init.lua</code> first.</p>
<ul>
<li>Function: <code>load_module_file</code></li>
<li>Function: <code>func_or_exten</code></li>
<li>Function: <code>user_setting_table</code></li>
</ul>
<p>Key part of codes are commented as follows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>astronvim.install <span style="color:#f92672">=</span> { home <span style="color:#f92672">=</span> stdpath <span style="color:#e6db74">&#34;config&#34;</span> } <span style="color:#75715e">-- ~/.config/nvim</span>
</span></span><span style="display:flex;"><span>astronvim.install.config <span style="color:#f92672">=</span> stdpath(<span style="color:#e6db74">&#34;config&#34;</span>):gsub(<span style="color:#e6db74">&#34;nvim$&#34;</span>, <span style="color:#e6db74">&#34;astronvim&#34;</span>) <span style="color:#75715e">-- ~/.config/`astronvim</span>
</span></span><span style="display:flex;"><span>vim.opt.rtp:append(astronvim.install.config) <span style="color:#75715e">-- extend rtp to include ~/.config/astronvim</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> supported_configs <span style="color:#f92672">=</span> { astronvim.install.home, astronvim.install.config }
</span></span><span style="display:flex;"><span> <span style="color:#75715e">-- support both ~/.config/nvim and ~/.config/`astronvim</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">load_module_file</span>(module)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">local</span> found_module <span style="color:#f92672">=</span> <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> _, config_path <span style="color:#66d9ef">in</span> ipairs(supported_configs) <span style="color:#66d9ef">do</span> <span style="color:#75715e">-- loop over 2 paths</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">local</span> module_path <span style="color:#f92672">=</span> config_path <span style="color:#f92672">..</span> <span style="color:#e6db74">&#34;/lua/&#34;</span> <span style="color:#f92672">..</span> module:gsub(<span style="color:#e6db74">&#34;%.&#34;</span>, <span style="color:#e6db74">&#34;/&#34;</span>) <span style="color:#f92672">..</span> <span style="color:#e6db74">&#34;.lua&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">-- module name with &#34;.&#34; -&gt; directory path with &#34;/&#34;.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> vim.fn.filereadable(module_path) <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">then</span> found_module <span style="color:#f92672">=</span> module_path <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> found_module <span style="color:#66d9ef">then</span> <span style="color:#75715e">-- if module file exists, load it safely with pcall.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">local</span> status_ok, loaded_module <span style="color:#f92672">=</span> pcall(require, module)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> status_ok <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>      found_module <span style="color:#f92672">=</span> loaded_module
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>      astronvim.notify(<span style="color:#e6db74">&#34;Error loading &#34;</span> <span style="color:#f92672">..</span> found_module, <span style="color:#e6db74">&#34;error&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> found_module
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>This extends load module capability not only from <code>/.config/nvim</code> but also
<code>~/.config/astronvim</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>astronvim.user_settings <span style="color:#f92672">=</span> load_module_file <span style="color:#e6db74">&#34;user.init&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">-- load from &#34;user/init.lua&#34; in `/.config/nvim` or `~/.config/`astronvim`.</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#66d9ef">local</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">func_or_extend</span>(overrides, default, extend)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> extend <span style="color:#66d9ef">then</span> <span style="color:#75715e">-- false for this part of code run</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> type(overrides) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;table&#34;</span> <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>      default <span style="color:#f92672">=</span> vim.tbl_deep_extend(<span style="color:#e6db74">&#34;force&#34;</span>, default, overrides)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elseif</span> type(overrides) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;function&#34;</span> <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>      default <span style="color:#f92672">=</span> overrides(default)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">elseif</span> overrides <span style="color:#f92672">~=</span> <span style="color:#66d9ef">nil</span> <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>    default <span style="color:#f92672">=</span> overrides
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> default
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>This seems to be the most ingeneous part of AstroNvim for user override
mechanism.  For <code>override</code>, if corresponding user module name is given and such
module exists, that result of user module is returned.  Otherwise, <code>default</code> in
the argument is returned.</p>
<p>This allows upstream code to set default values while a separate user module
file <code>~/.config/astronvim/lua/user/init.lua</code> can override it.  No variable
abstruction etc. involved.  Very nice.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#66d9ef">local</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">user_setting_table</span>(module)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">local</span> settings <span style="color:#f92672">=</span> astronvim.user_settings <span style="color:#f92672">or</span> {}
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> tbl <span style="color:#66d9ef">in</span> string.gmatch(module, <span style="color:#e6db74">&#34;([^%.]+)&#34;</span>) <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>    settings <span style="color:#f92672">=</span> settings[tbl]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> settings <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> <span style="color:#66d9ef">then</span> <span style="color:#66d9ef">break</span> <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> settings
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>This seems to look into inside of user module for particular <code>module</code> name <code>polish</code> for
the case under consideration.  It seems quite tricky.</p>
<p>See discussion at <a href="https://www.reddit.com/r/neovim/comments/v8d3lx/astronvim_v140/">reddit on astronvim v140</a>.</p>
<h3 id="other-user_plugin_opts">other <code>user_plugin_opts</code></h3>
<p>There are many other use of this hook function to enable user configuration.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ grep -R  -v <span style="color:#e6db74">&#34;^ *local&#34;</span> . 2&gt;/dev/null |grep user_plugin_opts|wc -l
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">44</span>
</span></span></code></pre></div><p>For those other <code>user_plugin_opts</code> in places other than <code>~/.config/init.lua</code>,
they don&rsquo;t use <code>polish</code> but has actual module name found under
<code>~/.config/astronvim/lua/user/</code> such as <code>plugins.packaer</code> for
<code>~/.config/astrovim/lua/user/plugins/packer</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">astronvim</span>.<span style="color:#a6e22e">user_plugin_opts</span>(module, default, extend, prefix)
</span></span><span style="display:flex;"><span>  module<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;plugins.packaer&#34;</span>
</span></span><span style="display:flex;"><span>  default <span style="color:#f92672">=</span> {some default values given ...}
</span></span><span style="display:flex;"><span>  extend<span style="color:#f92672">=</span><span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>  prefix<span style="color:#f92672">=</span><span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">local</span> user_settings <span style="color:#f92672">=</span> load_module_file(<span style="color:#e6db74">&#34;plugins.packer&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">-- user_settings = ~/.config/astrovim/lua/usr/plugins/packer.lua user configuration</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> user_settings <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> <span style="color:#66d9ef">then</span> user_settings <span style="color:#f92672">=</span> user_setting_table(<span style="color:#e6db74">&#34;polish&#34;</span>) <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">-- skip this</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> user_settings <span style="color:#f92672">~=</span> <span style="color:#66d9ef">nil</span> <span style="color:#66d9ef">then</span> default <span style="color:#f92672">=</span> func_or_extend(user_settings, { ...}, <span style="color:#66d9ef">nil</span>) <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">-- replace default by user_settings in  ~/.config/astrovim/lua/usr/plugins/packer.lua </span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> default
</span></span></code></pre></div><p>In some sense, this is simple replacement of the upstream setting by user
module.  Now I see where all maulti-file user configuration is coming from.</p>
<ul>
<li><a href="https://astronvim.github.io/configuration/splitting_up">Splitting Up Configuration</a></li>
<li><a href="https://astronvim.github.io/recipes/black_belt">Black Belt Example User Configs</a></li>
<li><a href="https://astronvim.github.io/configuration/override_formats#override-table">Override Table</a></li>
<li><a href="https://astronvim.github.io/configuration/override_formats#override-function">Override Function</a></li>
</ul>
<h2 id="customization">Customization</h2>
<p>I started to add some features quickly without learning internals of AstroNvim.  Features are the ones I created originally for DOOM-NVIM.  So I can control nvim behavior with simple key strokes.</p>
<ul>
<li>Toggle line number</li>
<li>Toggle toggle_signcolumn</li>
<li>&hellip;</li>
</ul>
<p>My latest updated PR is <a href="https://github.com/AstroNvim/AstroNvim/pull/769">https://github.com/AstroNvim/AstroNvim/pull/769</a></p>
<p>In my user configuration <code>~/.config/astronvim/lua/user/init.lua</code>, my <code>options</code> modification started simply as:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>  <span style="color:#75715e">-- set vim options here (vim.&lt;first_key&gt;.&lt;second_key&gt; =  value)</span>
</span></span><span style="display:flex;"><span>  options <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    opt <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>      relativenumber <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>, <span style="color:#75715e">-- unsets vim.opt.relativenumber</span>
</span></span><span style="display:flex;"><span>      number <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>,         <span style="color:#75715e">-- unsets vim.opt.number</span>
</span></span><span style="display:flex;"><span>      spell <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>,           <span style="color:#75715e">-- sets   vim.opt.spell</span>
</span></span><span style="display:flex;"><span>      signcolumn <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;no&#34;</span>,      <span style="color:#75715e">-- unsets vim.opt.signcolumn</span>
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    g <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>      mapleader <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34; &#34;</span>, <span style="color:#75715e">-- sets vim.g.mapleader</span>
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>  },
</span></span></code></pre></div><p>For more customization, see my latest configuration at <a href="https://github.com/osamuaoki/astronvim-osamu">https://github.com/osamuaoki/astronvim-osamu</a></p>
<h2 id="lazygit">Lazygit</h2>
<p>Lazygit is not yet packaged for Debian.  I installed it as:</p>
<pre tabindex="0"><code>$ sudo aptitude install golang
$ go install github.com/jesseduffield/lazygit@latest
$ cd ~/bin
$ ln -sf ~/go/bin/lazygit lazygit
</code></pre><h2 id="modifier-keys">Modifier keys</h2>
<p>Neovim 0.7 now correctly distinguishes modifier key combos in its own
input processing, so users can now map e.g. <code>&lt;Tab&gt;</code> and <code>&lt;C-I&gt;</code> separately.</p>
<h2 id="paste-mode">Paste mode</h2>
<p>By obsoleting needs for paste mode, Neovim deprecated it.  Neovim can tell
difference between actual key input from paste input.</p>
<!-- raw HTML omitted -->


<table width="100%">
  <tbody>
  <tr>
  
  <td align="left" width="33%"><a href="/en/2022/05/27/dgit-cheatsheet01/">Previous Post</a></td>
  
  <td align="center" width="33%"><a href="/en/">Top</a></td>
  
  <td align="right" width="33%"><a href="#">***</a></td>
  
  </tr>
  </tbody>
</table>

</main>

  <footer>
  
  
  <hr/>
  Â© 2013-2021 <a href="https://github.com/osamuaoki">Osamu Aoki</a>
  
  </footer>
  </body>
</html>

