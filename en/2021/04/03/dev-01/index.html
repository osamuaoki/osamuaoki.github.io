<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Development system (1) | Goofing Osamu</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    
  </head>

  <body>
    <nav>
    <ul class="menu">
      
      <li><a href="/">Home</a></li>
      
      <li><a href="/about/">About</a></li>
      
      <li><a href="/categories/">Categories</a></li>
      
      <li><a href="/tags/">Tags</a></li>
      
      <li><a href="/en/">English</a></li>
      
      <li><a href="/jp/">Japanese</a></li>
      
      <li><a href="/index.xml">Subscribe</a></li>
      
    </ul>
    <hr/>
    </nav>

<div class="article-meta">
<h1><span class="title">Development system (1)</span></h1>

<h3 class="date">Date:
2021/04/03 (initial publish),
2023/11/08 (last update)
</h3>
<h3 class="source">Source:
en/note-00012.md
</h3>
</div>

<main>


<table width="100%">
  <tbody>
  <tr>
  
  <td align="left" width="33%"><a href="/en/2021/01/15/debian-usability/">Previous Post</a></td>
  
  <td align="center" width="33%"><a href="/en/">Top</a></td>
  
  <td align="right" width="33%"><a href="/en/2021/04/09/dev-02/">Next Post</a></td>
  
  </tr>
  </tbody>
</table>

<h2>TOC</h2>

<nav id="TableOfContents">
  <ul>
    <li><a href="#development-infrastructure">Development infrastructure</a></li>
    <li><a href="#apt-proxy-on-host-ws">APT proxy on host WS</a>
      <ul>
        <li><a href="#set-up-proxy-for-the-local-apt">Set up proxy for the local APT</a></li>
        <li><a href="#permission-and-ownership">Permission and ownership</a></li>
      </ul>
    </li>
    <li><a href="#sbuild-infrastructure">Sbuild infrastructure</a>
      <ul>
        <li><a href="#setup">Setup</a></li>
        <li><a href="#package-build-with-sbuild">Package build with sbuild</a></li>
        <li><a href="#gbp-buildpackage-configuration">gbp-buildpackage configuration</a></li>
        <li><a href="#the-source-chroot-environment-used-by-sbuild">The source chroot environment used by sbuild</a></li>
        <li><a href="#reminder-for-adduser-package-in-the-source-chroot-environment-used-by-sbuild">Reminder for <code>adduser</code> package in the source chroot environment used by sbuild</a></li>
      </ul>
    </li>
    <li><a href="#schroot-infrastructure-shared-data-persistent">Schroot infrastructure (shared data, persistent)</a>
      <ul>
        <li><a href="#schroot-shell"><code>schroot-shell</code></a></li>
        <li><a href="#customizing-etcschrootdesktopfstab">Customizing <code>/etc/schroot/desktop/fstab</code></a></li>
        <li><a href="#access-to-the-persistent-chroot-environment-as-user">Access to the persistent chroot environment as user</a></li>
      </ul>
    </li>
    <li><a href="#chroot-update-optimization">Chroot update optimization</a>
      <ul>
        <li><a href="#via-eatmydata">Via <code>eatmydata</code></a></li>
        <li><a href="#via-tmpfs">Via <code>tmpfs</code></a></li>
        <li><a href="#bench-mark-results">Bench mark results</a></li>
      </ul>
    </li>
    <li><a href="#files-used-by-sbuild-and-schroot-shell">Files used by <code>sbuild</code> and <code>schroot-shell</code>.</a></li>
    <li><a href="#install-vm-infrastructure">Install VM infrastructure</a>
      <ul>
        <li><a href="#create-minimal-stable-vm">Create minimal stable VM</a></li>
        <li><a href="#creating-gnome-vm">Creating GNOME VM</a></li>
        <li><a href="#creating-sid-vm-for-development">Creating sid VM for development</a></li>
      </ul>
    </li>
    <li><a href="#vm-house-keepings">VM house keepings</a>
      <ul>
        <li><a href="#mixing-gnome-boxes-and-virt-manager">Mixing <code>gnome-boxes</code> and <code>virt-manager</code></a></li>
        <li><a href="#changing-hostname">Changing hostname</a></li>
        <li><a href="#setting-up-ssh">Setting up SSH</a></li>
        <li><a href="#setting-up-sudo">Setting up <code>sudo</code></a></li>
        <li><a href="#vm-tools">VM tools</a></li>
      </ul>
    </li>
    <li><a href="#helper-script">Helper script</a></li>
  </ul>
</nav>

<h2 id="development-infrastructure">Development infrastructure</h2>
<p>In order to keep development setups to be simple and robust, I changed
development infrastructure.</p>
<ul>
<li>For package test build, I decided to move to <code>schroot</code>.</li>
<li>For package build, I decided to move to <code>sbuild</code> (a <code>schroot</code> wrapper).</li>
<li>For package test for each GUI setups, I decided to set up KVM.</li>
</ul>
<p>(I was suffering sudden cowbuilder failures. That was another motivation.)</p>
<p>Planned infrastructure includes:</p>
<ul>
<li>APT proxy on the host WS.</li>
<li>Avahi mDNS environment which allows to use domain name &ldquo;local&rdquo;.</li>
<li>sbuild infrastructure for the clean chroot package build.</li>
<li>schroot infrastructure for the fully popullated chroot package test build.</li>
<li>VM as KVM for alternative package build environment (non-GUI)</li>
<li>VM as KVM for GUI package manual testing. (GUI)</li>
<li>SSH connections among host WS and guest VM systems.</li>
<li><a href="/en/2021/04/09/dev-02/">Mini private APT repo</a> or <a href="/en/2022/08/20/deb-repo-1/">Personal DEB package repository</a> to satisfy dependency as needed.</li>
</ul>
<p>Personal DEB package repository</p>
<h2 id="apt-proxy-on-host-ws">APT proxy on host WS</h2>
<p>In order to save the network traffic, I decided to set up APT proxy on the host
WS.</p>
<p>There are 4 good candidates.</p>
<ul>
<li><a href="https://salsa.debian.org/LeePen/apt-cacher">apt-cacher</a>: This needs to be installed with the web server.  Older code in perl (but it was newer than apt-.  Getting replaced by apt-cacher-ng.</li>
<li><a href="https://salsa.debian.org/blade/apt-cacher-ng/-/tree/debian/sid">apt-cacher-ng</a>: Newer and well maintained code in C++.
<ul>
<li>This package is <a href="https://qa.debian.org/popcon-graph.php?packages=apt-cacher+apt-cacher-ng+approx+squid-deb-proxy&amp;show_installed=on&amp;want_legend=on&amp;want_ticks=on&amp;from_date=&amp;to_date=&amp;hlght_date=&amp;date_fmt=%25Y-%25m&amp;beenhere=1">the most popular package</a>.</li>
<li>This package had <a href="https://wiki.debian.org/Simple-CDD/Howto?action=diff&amp;rev1=51&amp;rev2=50">some problem in 2010</a>.</li>
<li>Bookworm (testing) version seems to be in very good shape.</li>
</ul>
</li>
<li><a href="https://salsa.debian.org/ocaml-team/approx">approx</a>: Less docs but its simplicity seems to make it more robust.</li>
<li><a href="https://launchpad.net/squid-deb-proxy">squid-deb-proxy</a>: This needs generic proxy server (No way to read cached package data)</li>
</ul>
<p>It looks like <code>apt-cacher-ng</code> is the one for me to use.</p>
<ul>
<li>Execute: <code>apt install apt-cacher-ng</code></li>
<li>&ldquo;Set up once&rdquo; -&gt; &ldquo;keep&rdquo;&hellip; -&gt; &ldquo;Allow HTTP tunnels&hellip;&rdquo;: Yes</li>
</ul>
<h3 id="set-up-proxy-for-the-local-apt">Set up proxy for the local APT</h3>
<p>There are 2 interesting packages.</p>
<ul>
<li>auto-apt-proxy &ndash; no mDNS compatible &ndash;  <a href="https://salsa.debian.org/debian/auto-apt-proxy">https://salsa.debian.org/debian/auto-apt-proxy</a></li>
<li>squid-deb-proxy-client &ndash; mDNS compatible &ndash; <a href="https://launchpad.net/squid-deb-proxy">https://launchpad.net/squid-deb-proxy</a></li>
</ul>
<p>WARN: Installing <code>auto-apt-proxy</code> package without functioning proxy may cause
problem.</p>
<p>For my purpose, proxy is always the local for the host WS which is the gateway
WS for guest VMs(=kvm).  Simply installing <code>auto-apt-proxy</code> is suffice to set
up APT proxy for them.  For host WS itself or <code>chroot</code> (including ones created
through <code>schroot</code>, <code>sbuild</code>) environment on the host WS, proxy is always the
local.  So I simply add <code>/etc/apt/apt.conf.d/00proxy</code> as:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>Acquire::http <span style="color:#f92672">{</span> Proxy <span style="color:#e6db74">&#34;http://localhost:3142&#34;</span>; <span style="color:#f92672">}</span>
</span></span></code></pre></div><h3 id="permission-and-ownership">Permission and ownership</h3>
<p>The permission and ownership of <code>/var/cache/apt-cacher-ng/</code> is <code>drwxr-sr-x</code>
(2755) with <code>apt-cacher-ng:apt-cacher-ng</code>.</p>
<p>If you reinstall system, you must be careful with UID and GID since they may be
different for the reinstalled system.</p>
<p>If package files in upstream repo are replaced with different file with the
same name, it will create caching problem with <code>apt-cacher-ng</code>.  Non Debian
repository tends to do this. If you experience strange caching data related
issues, erase the whole data under <code>/var/cache/apt-cacher-ng/</code> for that repo to
reset situation.</p>
<h2 id="sbuild-infrastructure">Sbuild infrastructure</h2>
<p>Sbuild provides clean <strong>binary</strong> package building environment using schroot as its
backend.</p>
<h3 id="setup">Setup</h3>
<p>Here, I follow <a href="https://wiki.debian.org/sbuild">https://wiki.debian.org/sbuild</a> (I have made a few updates there,
too.).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ sudo apt install sbuild piuparts autopkgtest lintian
</span></span><span style="display:flex;"><span>$ adduser osamu sbuild
</span></span></code></pre></div><p>Logout and login to check you are a member of <code>sbuild</code> group.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ id
</span></span><span style="display:flex;"><span>uid<span style="color:#f92672">=</span>1000<span style="color:#f92672">(</span>osamu<span style="color:#f92672">)</span> gid<span style="color:#f92672">=</span>1000<span style="color:#f92672">(</span>osamu<span style="color:#f92672">)</span> groups<span style="color:#f92672">=</span>1000<span style="color:#f92672">(</span>osamu<span style="color:#f92672">)</span>,...,132<span style="color:#f92672">(</span>sbuild<span style="color:#f92672">)</span>
</span></span></code></pre></div><p>Let&rsquo;s create the configuration file <code>~/.sbuildrc</code> in line with recent Debian
practice <a href="https://wiki.debian.org/SourceOnlyUpload">https://wiki.debian.org/SourceOnlyUpload</a> as:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>cat &gt;~/.sbuildrc <span style="color:#e6db74">&lt;&lt; &#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">##############################################################################
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># PACKAGE BUILD RELATED (source-only-upload as default)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">##############################################################################
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># -d
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$distribution = &#39;unstable&#39;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># -A
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$build_arch_all = 1;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># -s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$build_source = 1;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># --source-only-changes or not
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># (1: for &#34;dput&#34;, 0: for &#34;dgit source-push&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$source_only_changes = 1;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># -v
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$verbose = 1;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># parallel build
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ENV{&#39;DEB_BUILD_OPTIONS&#39;} = &#39;parallel=12&#39;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">##############################################################################
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># POST-BUILD RELATED (turn off functionality by setting variables to 0)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">##############################################################################
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$run_lintian = 1;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$lintian_opts = [&#39;-i&#39;, &#39;-I&#39;];
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$run_piuparts = 1;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$piuparts_opts = [&#39;--schroot&#39;, &#39;unstable-amd64-sbuild&#39;, &#39;--no-eatmydata&#39;];
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$run_autopkgtest = 1;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$autopkgtest_root_args = &#39;&#39;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$autopkgtest_opts = [ &#39;--&#39;, &#39;schroot&#39;, &#39;%r-%a-sbuild&#39; ];
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">##############################################################################
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># PERL MAGIC
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">##############################################################################
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">1;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><p>You can disable and enable each functionality by assigning 0 or 1 to
corresponding variables.  You can customize this further for your GPG key etc.</p>
<p>Currently, I have several variants and switch among them with symlink.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ ls -l .sbuild*
</span></span><span style="display:flex;"><span>lrwxrwxrwx <span style="color:#ae81ff">1</span> osamu osamu   <span style="color:#ae81ff">13</span> May  <span style="color:#ae81ff">4</span> 07:58 .sbuildrc -&gt; .sbuildrc-src
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#ae81ff">1</span> osamu osamu <span style="color:#ae81ff">1377</span> May  <span style="color:#ae81ff">4</span> 07:58 .sbuildrc-bin
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#ae81ff">1</span> osamu osamu <span style="color:#ae81ff">1330</span> May  <span style="color:#ae81ff">4</span> 07:58 .sbuildrc-no-test
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#ae81ff">1</span> osamu osamu <span style="color:#ae81ff">1330</span> May  <span style="color:#ae81ff">4</span> 07:58 .sbuildrc-src
</span></span></code></pre></div><p>Then create the baseline chroot environment as:</p>
<p>If <code>apt-cacher-ng</code> is NOT used:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ sudo sbuild-createchroot --include<span style="color:#f92672">=</span>eatmydata,ccache unstable /srv/chroot/unstable-amd64-sbuild http://deb.debian.org/debian
</span></span></code></pre></div><p>If <code>apt-cacher-ng</code> is used:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ sudo sbuild-createchroot --include<span style="color:#f92672">=</span>eatmydata,ccache unstable /srv/chroot/unstable-amd64-sbuild http://127.0.0.1:3142/deb.debian.org/debian
</span></span></code></pre></div><p>(The difference can be resolved later by editing the <code>.../etc/apt/sources.list</code>
file found under <code>/srv/chroot/unstable-amd64-sbuild</code>.)</p>
<p>Please note that the above create <code>/etc/schroot/chroot.d/unstable-amd64-sbuild-$suffix</code> to be used by <code>schroot</code>.
(This file is effectively a split-up <code>/etc/schroot/schroot.conf</code> and this file needs to be removed together with the chroot system directory tree under <code>/srv/chroot/unstable-amd64-sbuild</code> to rerun above <code>sbuild-createchroot</code> if you messed up chroot contents.)</p>
<p>TODO: decide on technical merits: eatmydata or tmpfs for /build etc.</p>
<p>Prior to every use, you need to keep it up to date.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ sudo sbuild-update -udcar u
</span></span></code></pre></div><h3 id="package-build-with-sbuild">Package build with sbuild</h3>
<h4 id="for-unstable">For <code>unstable</code></h4>
<p>Package build from the source directory is simply as:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ sbuild
</span></span></code></pre></div><p>or using source package as:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ sbuild &lt;packagename&gt;.dsc
</span></span></code></pre></div><p>Hmmm&hellip; sbuild is now easier than pbuilder/cowbuilder and uses the new
bind-mount kernel feature smartly to make build environment quickly.</p>
<h4 id="for-testing">For <code>testing</code></h4>
<p>Package build from the source directory is simply as:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ sbuild -c testing-amd64-sbuild
</span></span></code></pre></div><h4 id="for-stable">For <code>stable</code></h4>
<p>Package build from the source directory is simply as:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ sbuild -c stable-amd64-sbuild
</span></span></code></pre></div><h3 id="gbp-buildpackage-configuration">gbp-buildpackage configuration</h3>
<p>I changed gbp-buildpackage to use sbuild.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#f92672">[</span>DEFAULT<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># the default build command:</span>
</span></span><span style="display:flex;"><span>builder <span style="color:#f92672">=</span> sbuild -A -s --source-only-changes -v -d unstable
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>(Actually, with the above <code>~/.sbuildrc</code>, we should be able to skip options after
<code>sbuild</code> here.)</p>
<h3 id="the-source-chroot-environment-used-by-sbuild">The source chroot environment used by sbuild</h3>
<p>In order to access the minimum unstable chroot environment used by sbuild, use the standard command.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ sudo sbuild-shell u
</span></span></code></pre></div><p>In order to update the minimum unstable chroot environment used by sbuild, use the standard command.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ sudo sbuild-update -udcar u
</span></span></code></pre></div><p>In order to access the minimum oldstable chroot environment used by sbuild, use the standard command.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ sudo schroot-shell -u o
</span></span></code></pre></div><p>In order to update the minimum oldstable chroot environment used by sbuild, use the standard command.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ sudo sbuild-update -udcar o
</span></span></code></pre></div><h3 id="reminder-for-adduser-package-in-the-source-chroot-environment-used-by-sbuild">Reminder for <code>adduser</code> package in the source chroot environment used by sbuild</h3>
<p>The above update method for <code>schroot</code> generally works for normal situation.
But when an essential package becomes a non-essential one (e.g., <code>adduser</code>),
this causes a problem with <code>piuparts</code> test.  Make sure to remove such package
manually from the source chroot environment.</p>
<h2 id="schroot-infrastructure-shared-data-persistent">Schroot infrastructure (shared data, persistent)</h2>
<p>For package development, creating the test build environment starting from the
latest minimal chroot environment is time consuming.  For this situation, it&rsquo;s
better to have all required packages installed and have access to data in your
home directory.</p>
<p>Let&rsquo;s create package pre-loaded chroot environments which can run x-apps using
the schroot directly using a configuration profile based on
<code>/etc/schroot/desktop/</code>.</p>
<h3 id="schroot-shell"><code>schroot-shell</code></h3>
<p>Since this is a bit repetitive tasks for oldstable, stable, testing, and
unstable, I created a simple shell script:</p>
<ul>
<li><a href="https://github.com/osamuaoki/osamu-utils/blob/main/schroot-shell">https://github.com/osamuaoki/osamu-utils/blob/main/schroot-shell</a></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ schroot-shell -h
</span></span><span style="display:flex;"><span>NAME
</span></span><span style="display:flex;"><span>    schroot-shell - start a shell in chroot with current home data.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>SYNOPSIS
</span></span><span style="display:flex;"><span>    schroot-shell <span style="color:#f92672">[</span>DIST <span style="color:#f92672">[</span>CONFIG<span style="color:#f92672">]]</span>
</span></span><span style="display:flex;"><span>    schroot-shell --config <span style="color:#f92672">[</span>CONFIG<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    schroot-shell <span style="color:#f92672">[</span>--init|--prep|--upgrade<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>DIST <span style="color:#f92672">[</span>CONFIG<span style="color:#f92672">]]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>DESCRIPTION
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>This wrapper command of *schroot* offers a set of helper commands to work in
</span></span><span style="display:flex;"><span>the persistent pre-loaded <span style="color:#f92672">(</span>source<span style="color:#f92672">)</span> chroot system environment <span style="color:#66d9ef">while</span> sharing the
</span></span><span style="display:flex;"><span>user data from the user<span style="color:#e6db74">&#39;s home directory of the host system.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Here, if &#39;</span>CONFIG<span style="color:#e6db74">&#39; and &#39;</span>DIST<span style="color:#e6db74">&#39; are missing in the command line, &#39;</span>desktop<span style="color:#e6db74">&#39; for
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;</span>CONFIG<span style="color:#e6db74">&#39; and &#39;</span>unstable<span style="color:#e6db74">&#39; for &#39;</span>DIST<span style="color:#e6db74">&#39; are used as the default values.  Normally,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">you skip specifying &#39;</span>CONFIG<span style="color:#e6db74">&#39; to use its default value.  This command
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">automatically becomes root when needed.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">The *schroot-shell* command is normally invoked as:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   schroot-shell [DIST [CONFIG]]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">This starts an interactive shell in the &#39;</span>DIST-amd64-CONFIG<span style="color:#e6db74">&#39; source chroot
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">managed by the *schroot* command while bind mounting the user data from the
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">user&#39;</span>s home directory of the host system.  This is somewhat modeled after
</span></span><span style="display:flex;"><span>*sbuild-shell*.  While *sbuild-shell* is designed to work with the session
</span></span><span style="display:flex;"><span>chroot and the changes made from *sbuild-shell* to the chroot is discarded,
</span></span><span style="display:flex;"><span>the changes made from *schroot-shell* to the chroot is persistent.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In order <span style="color:#66d9ef">for</span> the *schroot-shell* command to <span style="color:#66d9ef">function</span>, you need to set up the
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;DIST-amd64-CONFIG&#39;</span> source chroot properly.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>The <span style="color:#e6db74">&#39;DIST-amd64-CONFIG&#39;</span> source chroot can be initialized in <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>steps.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  1. Create the setup script configuration files <span style="color:#66d9ef">for</span> *schroot* under
</span></span><span style="display:flex;"><span>     <span style="color:#e6db74">&#39;/etc/schroot/CONFIG/&#39;</span> as explained in the <span style="color:#e6db74">&#39;FILES&#39;</span> section under <span style="color:#e6db74">&#39;Setup
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     script configuration&#39;</span> in schroot.conf<span style="color:#f92672">(</span>5<span style="color:#f92672">)</span> <span style="color:#66d9ef">for</span> <span style="color:#e6db74">&#39;/etc/schroot/default&#39;</span>.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>       schroot-shell --config <span style="color:#f92672">[</span>CONFIG<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  2. Customize the setup script configuration files <span style="color:#66d9ef">for</span> *schroot* at
</span></span><span style="display:flex;"><span>     <span style="color:#e6db74">&#39;/etc/schroot/CONFIG/fstab&#39;</span> to list all mounted devices in your home
</span></span><span style="display:flex;"><span>     directory.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  3. Create a chroot file system <span style="color:#66d9ef">for</span> <span style="color:#e6db74">&#39;DIST&#39;</span> at
</span></span><span style="display:flex;"><span>     <span style="color:#e6db74">&#39;/srv/chroot/DIST-amd64-CONFIG&#39;</span> using the setup script configuration
</span></span><span style="display:flex;"><span>     files in <span style="color:#e6db74">&#39;/etc/schroot/CONFIG&#39;</span>.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>       schroot-shell --init <span style="color:#f92672">[</span>DIST <span style="color:#f92672">[</span>CONFIG<span style="color:#f92672">]]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Here, <span style="color:#e6db74">&#39;DIST&#39;</span> specifies base distribution of the chroot system.  <span style="color:#e6db74">&#39;DIST&#39;</span>
</span></span><span style="display:flex;"><span>    can be <span style="color:#e6db74">&#39;unstable&#39;</span> <span style="color:#f92672">(</span>default<span style="color:#f92672">)</span>, <span style="color:#e6db74">&#39;testing&#39;</span>, <span style="color:#e6db74">&#39;stable&#39;</span>, <span style="color:#e6db74">&#39;oldstable&#39;</span>, or
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;oldoldstable&#39;</span>.  These can be shortened as <span style="color:#e6db74">&#39;u&#39;</span>, <span style="color:#e6db74">&#39;t&#39;</span>, <span style="color:#e6db74">&#39;s&#39;</span>, <span style="color:#e6db74">&#39;o&#39;</span>, or <span style="color:#e6db74">&#39;oo&#39;</span>
</span></span><span style="display:flex;"><span>    in the command line.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>The <span style="color:#e6db74">&#39;DIST-amd64-CONFIG&#39;</span> source chroot can be updated to the latest
</span></span><span style="display:flex;"><span>state by:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   schroot-shell --update <span style="color:#f92672">[</span>DIST <span style="color:#f92672">[</span>CONFIG<span style="color:#f92672">]]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>The <span style="color:#e6db74">&#39;DIST-amd64-CONFIG&#39;</span> source chroot can be prepped up with a few
</span></span><span style="display:flex;"><span>pre-defined extra packages desirable <span style="color:#66d9ef">for</span> the shell activities by:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   schroot-shell --prep <span style="color:#f92672">[</span>DIST <span style="color:#f92672">[</span>CONFIG<span style="color:#f92672">]]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>For <span style="color:#e6db74">&#39;CONFIG&#39;</span>, values <span style="color:#e6db74">&#39;default&#39;</span>, <span style="color:#e6db74">&#39;minimal&#39;</span>, <span style="color:#e6db74">&#39;buildd&#39;</span>, and <span style="color:#e6db74">&#39;sbuild&#39;</span>
</span></span><span style="display:flex;"><span>should be avoided unless you know what exactly happens since these setup
</span></span><span style="display:flex;"><span>scripts are already used by *sbuild* and *schroot*.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>The *schroot-shell* command offers a generarized and similar functionality of
</span></span><span style="display:flex;"><span>combined *sbuild-createchroot*, *sbuild-update*, and *sbuild-shell* <span style="color:#66d9ef">for</span> the
</span></span><span style="display:flex;"><span>persistent chroot shell environment instead of the session one.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Parametrs:
</span></span><span style="display:flex;"><span>  TYPE    <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;source&#39;</span>
</span></span><span style="display:flex;"><span>  DIST    <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;unstable&#39;</span>
</span></span><span style="display:flex;"><span>  ARCH    <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;amd64&#39;</span>
</span></span><span style="display:flex;"><span>  CONFIG  <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;desktop&#39;</span>
</span></span></code></pre></div><h3 id="customizing-etcschrootdesktopfstab">Customizing <code>/etc/schroot/desktop/fstab</code></h3>
<p>I customized my desktop profile at <code>/etc/schroot/desktop/fstab</code> as follows:</p>
<ul>
<li>Explicitly bind mount subdirectories under my home directory which are on
different devices (including Btrfs subvolumes).</li>
<li>Bind mount /root</li>
</ul>
<h3 id="access-to-the-persistent-chroot-environment-as-user">Access to the persistent chroot environment as user</h3>
<p>In order to access the pre-loaded unstable chroot environment, I simply type.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ schroot-shell
</span></span></code></pre></div><p>In order to update the pre-loaded unstable chroot environment, I simply type.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ schroot-shell -u
</span></span></code></pre></div><p>In order to access the pre-loaded oldstable chroot environment, I simply type.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ schroot-shell o
</span></span></code></pre></div><p>In order to update the pre-loaded oldstable chroot environment, I simply type.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ schroot-shell -u o
</span></span></code></pre></div><h2 id="chroot-update-optimization">Chroot update optimization</h2>
<p>Slow <code>fsync</code>(2) process problem caused by <code>dpkg</code> and SSD waring problem can be avoided.</p>
<h3 id="via-eatmydata">Via <code>eatmydata</code></h3>
<p>Add following line into <code>/etc/schroot/chroot.d/unstable-amd64-sbuild-$suffix</code> or similar to speed up the package installation process.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>command-prefix<span style="color:#f92672">=</span>eatmydata
</span></span></code></pre></div><h3 id="via-tmpfs">Via <code>tmpfs</code></h3>
<p>Add following to my <code>/etc/fstab</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e"># For speeding up sbuild/schroot and prevent SSD wear-out</span>
</span></span><span style="display:flex;"><span>none /var/lib/schroot/session        tmpfs uid<span style="color:#f92672">=</span>root,gid<span style="color:#f92672">=</span>root,mode<span style="color:#f92672">=</span><span style="color:#ae81ff">0755</span> <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>none /var/lib/schroot/union/overlay  tmpfs uid<span style="color:#f92672">=</span>root,gid<span style="color:#f92672">=</span>root,mode<span style="color:#f92672">=</span><span style="color:#ae81ff">0755</span> <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>none /var/lib/sbuild/build           tmpfs uid<span style="color:#f92672">=</span>sbuild,gid<span style="color:#f92672">=</span>sbuild,mode<span style="color:#f92672">=</span><span style="color:#ae81ff">2770</span> <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">0</span>
</span></span></code></pre></div><p>Here, I note a few notable directories:</p>
<ul>
<li><code>/srv/chroot</code>: directory containing whole initial chroot environment.</li>
<li><code>/var/lib/schroot/union/overlay</code>: directory where additional packages are
installed during the build process.</li>
<li><code>/var/lib/sbuild/build</code>: directory where the source package is unpacked and
build.</li>
</ul>
<p>Please be aware, these directory may eat up some disk spaces and you should have enough DRAM.</p>
<h3 id="bench-mark-results">Bench mark results</h3>
<p>Very rough benchmarks were performed to see impact of eatmydata, tmpfs, and
parallel build.</p>
<p>System used:</p>
<ul>
<li>AMD Ryzen 5 PRO 4650U with Radeon Graphics (Units/Processor: 12)</li>
<li>TS2TMTE220S (2TB NVMe SSD) &ndash; used</li>
<li>WDC PC SN520 SDAPMUW-128G-1001 (128GB NVMe SSD)</li>
<li>Wifi (802.11ac 5GHz) to Optical connection. (about 3 M Bytes/sec)</li>
<li>Source:
<ul>
<li>DR: debian-reference source (original not to do parallel build)</li>
<li>DR&rsquo;: debian-reference source (modified to do parallel build)</li>
<li>GIT: git source</li>
</ul>
</li>
</ul>
<p>Result:</p>
<table>
<thead>
<tr>
<th>source</th>
<th>eatmydata</th>
<th>tmpfs</th>
<th>parallel</th>
<th>real</th>
<th>user</th>
<th>system</th>
<th>Note</th>
</tr>
</thead>
<tbody>
<tr>
<td>DR</td>
<td>no</td>
<td>yes</td>
<td>1</td>
<td>20m54s</td>
<td>18m12s</td>
<td>0m47s</td>
<td>Cold APT</td>
</tr>
<tr>
<td>DR</td>
<td>yes</td>
<td>yes</td>
<td>1</td>
<td>17m08s</td>
<td>17m32s</td>
<td>0m34s</td>
<td></td>
</tr>
<tr>
<td>DR</td>
<td>no</td>
<td>yes</td>
<td>1</td>
<td>17m56s</td>
<td>18m09s</td>
<td>0m45s</td>
<td></td>
</tr>
<tr>
<td>DR</td>
<td>no</td>
<td>no</td>
<td>1</td>
<td>19m24s</td>
<td>18m12s</td>
<td>1m21s</td>
<td>No speed-up</td>
</tr>
<tr>
<td>DR</td>
<td>yes</td>
<td>no</td>
<td>1</td>
<td>17m10s</td>
<td>17m28s</td>
<td>0m43s</td>
<td></td>
</tr>
<tr>
<td>DR'</td>
<td>yes</td>
<td>no</td>
<td>24</td>
<td>5m02s</td>
<td>31m05s</td>
<td>0m54s</td>
<td></td>
</tr>
<tr>
<td>DR'</td>
<td>yes</td>
<td>yes</td>
<td>24</td>
<td>5m02s</td>
<td>31m05s</td>
<td>0m54s</td>
<td></td>
</tr>
<tr>
<td>DR'</td>
<td>yes</td>
<td>no</td>
<td>24</td>
<td>6m34s</td>
<td>35m37s</td>
<td>0m56s</td>
<td></td>
</tr>
<tr>
<td>GIT</td>
<td>yes</td>
<td>yes</td>
<td>24</td>
<td>7m24s</td>
<td>33m23s</td>
<td>9m45s</td>
<td>Cool CPU</td>
</tr>
<tr>
<td>GIT</td>
<td>yes</td>
<td>no</td>
<td>24</td>
<td>7m51s</td>
<td>38m18s</td>
<td>12m00s</td>
<td>Hot CPU</td>
</tr>
<tr>
<td>GIT</td>
<td>yes</td>
<td>yes</td>
<td>24</td>
<td>7m21s</td>
<td>35m08s</td>
<td>12m34s</td>
<td>Hotter CPU</td>
</tr>
</tbody>
</table>
<p>Observation for real:</p>
<ul>
<li>Cold APT cache  &ndash; 10% slow down (not much)</li>
<li>Hot CPU  &ndash; 7% slowdown (not much)</li>
<li>Use of tmpfs  &ndash; no impact</li>
<li>Use of eatmydata &ndash; 10% speed up (not much)</li>
<li>Use of parallel &ndash; less than half (big gain but build log became cryptic)</li>
</ul>
<p>Conclusion:</p>
<ul>
<li>Use of APT cache is for reducing repository server load. (I have fast
connection)</li>
<li>Use of eatmydata is for skipping unnecessary waiting. (It may cause
complication due to version so I stop using it.)</li>
<li>Use of tmpfs is more for longer SSD life.  (I have lots of DRAM)</li>
</ul>
<h2 id="files-used-by-sbuild-and-schroot-shell">Files used by <code>sbuild</code> and <code>schroot-shell</code>.</h2>
<p>The <code>sbuild</code> and <code>schroot-shell</code> use following files.</p>
<ul>
<li><code>~/.sbuildrc</code> by <code>sbuild</code>.</li>
<li><code>/etc/sbuild/chroot</code> containing symlinks to the root of the <code>chroot</code> used by
<code>sbuild</code>.</li>
<li><code>/etc/schroot/chroot.d/</code> containing configuration files for <code>schroot</code> used by
<code>sbuild</code> and <code>schroot-shell</code>.</li>
<li><code>/etc/schroot/desktop/</code> contents customized for use by <code>schroot-shell</code>.</li>
<li><code>/srv/chroot/</code> containing the root of the <code>chroot</code> used by <code>sbuild</code> and
<code>schroot-shell</code>.</li>
</ul>
<h2 id="install-vm-infrastructure">Install VM infrastructure</h2>
<ul>
<li>Execute: <code>apt install virt-manager gnome-boxes</code></li>
<li>Read /usr/share/doc/libvirt-daemon/README.Debian.gz and follow it.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ sudo bash
</span></span><span style="display:flex;"><span><span style="color:#75715e"># virsh net-start default</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># virsh net-autostart default</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># mkdir /etc/dnsmasq.d</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># cat &lt;&lt;EOF &gt;/etc/dnsmasq.d/00_libvirtd.conf</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># only bind to loopback by default</span>
</span></span><span style="display:flex;"><span>interface<span style="color:#f92672">=</span>lo
</span></span><span style="display:flex;"><span>bind-interfaces
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ^D</span>
</span></span></code></pre></div><h3 id="create-minimal-stable-vm">Create minimal stable VM</h3>
<p>(This needs to be updated for &ldquo;bullseye&rdquo;.  It should be quite similar.  I primarily use gnome-boxes now.)</p>
<ul>
<li>Download the ISO for Debian stable. (netinst: 337MiB)</li>
<li>Start virt-manager</li>
<li>Create a new virtual machine from Debian stable ISO without Desktop (Use
en_US).
<ul>
<li>Name as &ldquo;debian10&rdquo; (automtic)</li>
<li>Format: qcow2</li>
<li>Capacity: 20GiB</li>
<li>Mostly go with defaults</li>
<li>Activate virtual network</li>
<li>Guided - use entire disk</li>
<li>Write disk - Yes</li>
<li>Unset &ldquo;Debian desktop environment&rdquo; and &ldquo;print server&rdquo;, and set &ldquo;SSH server&rdquo;</li>
<li>GRUB install to MBR: Yes, <code>/dev/vda</code></li>
<li>Installation complete and GRUB screen -&gt; VM started</li>
<li>Shutdown VM</li>
<li>Clone from &ldquo;debian10&rdquo; to &ldquo;buster-mini&rdquo;</li>
<li>Start &ldquo;buster-mini&rdquo; and login to &ldquo;root&rdquo;
<ul>
<li><code>apt-get update&amp;&amp; apt-get install vim nano- aptitude screen gpm avahi-utils</code>
<ul>
<li>Installation of <code>gpm</code> package allows me to see mouse pointer on the
Linux console.  This makes it easier to get out of fullscreen mode by
moving mouse cursor to the top center. (Some times it moves strangely
but OK for this purpose.)</li>
<li>Installation of <code>avahi-utils</code> allows easy access to local hosts.</li>
</ul>
</li>
</ul>
</li>
<li>Shutdown &ldquo;buster-mini&rdquo; with <code>shutdown -h now</code>.</li>
</ul>
</li>
</ul>
<h3 id="creating-gnome-vm">Creating GNOME VM</h3>
<ul>
<li>Clone from &ldquo;buster-mini&rdquo; to &ldquo;buster-GNOME&rdquo;</li>
<li>Start &ldquo;buster-GNOME&rdquo; and login to &ldquo;root&rdquo;
<ul>
<li><code>apt-get update&amp;&amp; apt-get install task-gnome-desktop</code></li>
</ul>
</li>
<li>If you get errors from aptitude, go to host and fix apt-cacher-ng
repository and than try again.  (Don&rsquo;t use <code>--fix-missing</code>)</li>
<li>Rebooting VM got me to nice GNOME system up.</li>
</ul>
<h3 id="creating-sid-vm-for-development">Creating sid VM for development</h3>
<ul>
<li>Clone from &ldquo;debian10&rdquo; to &ldquo;sid-dev&rdquo;</li>
<li>Change <code>/etc/apt/sources.list</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>deb http://deb.debian.org/debian/ sid main
</span></span><span style="display:flex;"><span>deb-src http://deb.debian.org/debian/ sid main
</span></span></code></pre></div><ul>
<li><code>apt-get update &amp;&amp; apt-get dist-upgrade &amp;&amp; apt autoremove</code></li>
<li><code>apt-get install devscripts</code></li>
</ul>
<h2 id="vm-house-keepings">VM house keepings</h2>
<h3 id="mixing-gnome-boxes-and-virt-manager">Mixing <code>gnome-boxes</code> and <code>virt-manager</code></h3>
<p>You can add VMs created by <code>gnome-boxes</code> to <code>virt-manager</code> by selecting
<code>QEM/KVM User session</code> instead of <code>QEM/KVM</code> in <code>File -&gt; New connection</code> menu.</p>
<h3 id="changing-hostname">Changing hostname</h3>
<p>To change hostname of the VM permanently, you need to edit <code>/etc/hostname</code> and
<code>/etc/hosts</code> and reboot the VM.  (The hostname of running system can be set to
&ldquo;<!-- raw HTML omitted -->&rdquo; just as <code>hostname &lt;newhostname&gt;</code> but updates of mDNS record
seen from other VMs and the host WS need reboot of the VM.)</p>
<h3 id="setting-up-ssh">Setting up SSH</h3>
<p>As long as the host WS and guest VMs are installed with <code>avahi-utils</code>, we can
use each host name appended with &ldquo;<code>.local</code>&rdquo; to access using good old SSH.  For
example between VMs.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>osamu@sid-dev:~$ ssh sid-GNOME.local
</span></span></code></pre></div><p>SSH login directly to root account of a system are probably blocked.  In that
case, you must SSH into user account first and sudo/su to root.</p>
<p>Use of SSH key placed in user&rsquo;s home directory is a good idea.  Typical key
generation goes:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>osamu@sid-dev:~$ ssh-keygen -t rsa
</span></span></code></pre></div><p>This should create:</p>
<ul>
<li><code>id_rsa</code> contains the private key</li>
<li><code>id_rsa.pub</code> contains the public key</li>
</ul>
<p>In order to give passwordless SSH access from an account on <code>sid-dev</code> to an
account on <code>sid-GNOME</code>, you need to append the content of <code>id_rsa.pub</code> on
<code>sid-dev</code> to <code>~/.ssh/authorized_keys</code> on the <code>sid-GNOME</code>.</p>
<p>Please make sure to set proper permissions on the remote host:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>osamu@sid-GNOME $ chmod <span style="color:#ae81ff">700</span> ~/.ssh
</span></span><span style="display:flex;"><span>osamu@sid-GNOME $ chmod <span style="color:#ae81ff">600</span> ~/.ssh/authorized_keys
</span></span></code></pre></div><h3 id="setting-up-sudo">Setting up <code>sudo</code></h3>
<p>Following will configure <code>sudo</code> to allow user &ldquo;osamu&rdquo; for root privilege.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span> $ su
</span></span><span style="display:flex;"><span>Password:
</span></span><span style="display:flex;"><span>root@sid-dev:/home/osamu# /sbin/adduser osamu sudo
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>root@sid-dev:/home/osamu# echo &gt;/etc/sudoers.d/passwordless <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># NO password for the primary user
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">%sudo ALL = (ALL) NOPASSWD: ALL
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><h3 id="vm-tools">VM tools</h3>
<p>I am not familiar with VM oriented tools yet.  Following packages seem
something to learn.</p>
<ul>
<li><a href="https://libvirt.org/">https://libvirt.org/</a> supporting EMU, KVM, XEN, OpenVZ, LXC, and
VirtualBox.
<ul>
<li><code>libvirt-clients</code> (<code>virsh</code> command etc.)</li>
<li><code>virt-manager</code>: desktop application</li>
<li><code>virtinst</code>: CLI equiv of <code>virt-manage</code></li>
<li><code>libvirt-login-shell</code>: isolate user sessions using LXC container</li>
</ul>
</li>
<li><a href="http://libguestfs.org">http://libguestfs.org</a> <a href="https://libguestfs.org/guestfs-faq.1.html">FAQ</a></li>
<li><code>libguestfs-tools</code>: guest disk image management system</li>
</ul>
<h2 id="helper-script">Helper script</h2>
<p>I created short scripts and use them to initialize Debian VMs.  This also takes
care SSH keys: <a href="https://github.com/osamuaoki/vm-setup">https://github.com/osamuaoki/vm-setup</a></p>
<!-- raw HTML omitted -->


<table width="100%">
  <tbody>
  <tr>
  
  <td align="left" width="33%"><a href="/en/2021/01/15/debian-usability/">Previous Post</a></td>
  
  <td align="center" width="33%"><a href="/en/">Top</a></td>
  
  <td align="right" width="33%"><a href="/en/2021/04/09/dev-02/">Next Post</a></td>
  
  </tr>
  </tbody>
</table>

</main>

  <footer>
  
  
  <hr/>
  © 2013-2023 <a href="https://github.com/osamuaoki">Osamu Aoki</a>
  
  </footer>
  </body>
</html>

