<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Re-learning Vim (3) | Goofing Osamu</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    
  </head>

  <body>
    <nav>
    <ul class="menu">
      
      <li><a href="/">Home</a></li>
      
      <li><a href="/about/">About</a></li>
      
      <li><a href="/categories/">Categories</a></li>
      
      <li><a href="/tags/">Tags</a></li>
      
      <li><a href="/en/">English</a></li>
      
      <li><a href="/jp/">Japanese</a></li>
      
      <li><a href="/index.xml">Subscribe</a></li>
      
    </ul>
    <hr/>
    </nav>

<div class="article-meta">
<h1><span class="title">Re-learning Vim (3)</span></h1>

<h3 class="date">Date:
2021/09/12 (initial publish),
2022/07/20 (last update)
</h3>
<h3 class="source">Source:
en/note-00027.md
</h3>
</div>

<main>


<table width="100%">
  <tbody>
  <tr>
  
  <td align="left" width="33%"><a href="/en/2021/08/28/git-submodule-01/">Previous Post</a></td>
  
  <td align="center" width="33%"><a href="/en/">Top</a></td>
  
  <td align="right" width="33%"><a href="/en/2021/11/02/backup-1/">Next Post</a></td>
  
  </tr>
  </tbody>
</table>

<h2>TOC</h2>

<nav id="TableOfContents">
  <ul>
    <li><a href="#neovim-05-migration">Neovim 0.5 migration</a></li>
    <li><a href="#terminal-settings">Terminal settings</a></li>
    <li><a href="#key-bindings">Key bindings</a></li>
    <li><a href="#dependency-package-management">Dependency package management</a></li>
    <li><a href="#main-configuration-management">Main configuration management</a></li>
    <li><a href="#help">help</a></li>
    <li><a href="#skipped-programs">Skipped programs</a></li>
    <li><a href="#note-on-delayed-loading">Note on delayed loading</a></li>
    <li><a href="#map">map</a></li>
    <li><a href="#upstreamed-mod-for-tweak">Upstreamed mod for &ldquo;Tweak&rdquo;</a></li>
    <li><a href="#todo">TODO</a></li>
  </ul>
</nav>

<p>This page is here as my old memo and contents are outdated. See:</p>
<ul>
<li><a href="/en/2019/09/17/vim-learn-1/">Re-learning Vim (1)</a></li>
<li><a href="/en/2022/07/15/vim-learn-4/">Re-learning Vim (4)</a></li>
</ul>
<h2 id="neovim-05-migration">Neovim 0.5 migration</h2>
<p>After finding out <strong>Neovim</strong> (nvim) 0.5 starts up 30%-40% faster than <strong>Vim 8</strong>
probably due to asynchronous processing and more effective use of multi-core
modern CPU, I decided to migrate to nvim.  Then lua thing got my attention.
Since nvim source package for version 0.5 was available in Debian experimental,
I made a local package from it.  So I am in good shape to try the latest lua
scripts.</p>
<p>After translating my old vimrc to lua as <a href="https://github.com/osamuaoki/dot-nvim">https://github.com/osamuaoki/dot-nvim</a>
, I realized this isn&rsquo;t going anywhere.  It was easy to convert
<code>.config/nvim/init.vim</code> but it was hard to decide how to migrate all my vimL
based packages to new new lua based ones.</p>
<p>I found 3 interesting projects which offer examples for how this is done.</p>
<ul>
<li>Lunar Vim
<ul>
<li>SRC: <a href="https://github.com/LunarVim/LunarVim">https://github.com/LunarVim/LunarVim</a></li>
<li>HOME: <a href="https://www.lunarvim.org/#opinionated">https://www.lunarvim.org/#opinionated</a></li>
</ul>
</li>
<li>NvChad
<ul>
<li>SRC: <a href="https://github.com/NvChad/NvChad">https://github.com/NvChad/NvChad</a></li>
<li>WIKI: <a href="https://github.com/NvChad/NvChad/wiki">https://github.com/NvChad/NvChad/wiki</a> (old?</li>
<li>HOME: <a href="https://nvchad.netlify.app/">https://nvchad.netlify.app/</a></li>
</ul>
</li>
<li>DOOM-NVIM
<ul>
<li>SRC: <a href="https://github.com/NTBBloodbath/doom-nvim">https://github.com/NTBBloodbath/doom-nvim</a></li>
</ul>
</li>
</ul>
<p>For ease of customization, I chose NvChad.  Result was great start-up time
reduction.</p>
<ul>
<li>vim  230 ms (dot-vim in vimL)</li>
<li>nvim 161 ms (dot-nvim in lua starting vimL packages)</li>
<li>nvim  65 ms (NvChad in all lua)  &ndash; use lazy loading</li>
<li>nvim  44-60 ms (doom-nvim in all lua) &ndash; use lazy loading more (?)</li>
</ul>
<p>Doom-Nvim report it started in 0.013-0.040 s on the bottom of the opening screen if I scrolled down.  The value is nowhere seen on the log generated by `vi &ndash;startuptime &hellip;``.</p>
<pre tabindex="0"><code>times in msec
 clock   self+sourced   self:  sourced script
 clock   elapsed:              other lines

000.012  000.012: --- NVIM STARTING ---
...
003.926  000.038: initialized screen early for UI
...
013.482  009.341  008.970: sourcing /home/osamu/.config/nvim/init.lua
013.507  000.241: sourcing vimrc file(s)
...
043.248  026.179  026.179: sourcing /home/osamu/.config/nvim/plugin/packer_compiled.lua
043.622  001.985: loading plugins
...
046.493  001.711: loading packages
046.952  000.459: loading after plugins
046.970  000.018: inits 3
046.973  000.003: reading ShaDa
...
053.165  004.798: opening buffers
053.764  000.599: BufEnter autocommands
053.773  000.009: editing files in windows
...
058.531  004.216: VimEnter autocommands
058.535  000.004: UIEnter autocommands
058.537  000.002: before starting main loop
059.987  001.449: first screen update
059.994  000.007: --- NVIM STARTED ---
</code></pre><p>Here,</p>
<ul>
<li><code>BufEnter</code> is a hook useful for setting options for a file type.</li>
<li><code>VimEnter</code> is a hook after doing all the startup stuff</li>
<li><code>UIEnter</code>  is a hook after doing all the GUI startup stuff</li>
</ul>
<p>Here is my memo on how to use DOOM-NVIM and customize it.</p>
<h2 id="terminal-settings">Terminal settings</h2>
<p>Set DEL-code(0x7F) for Backspace and use escape sequence for Delete.  This
frees the ASCII BS (CTRL-H) code so window jump can be mapped to <code>&lt;C-H&gt;</code>.</p>
<p>Now I see why this was default.</p>
<h2 id="key-bindings">Key bindings</h2>
<p>I am keeping mostly default key bindings for now.</p>
<ul>
<li>Vim&rsquo;s original key bindings:
<ul>
<li><code>:help index</code></li>
</ul>
</li>
<li>Configuration introduced key bindings (with opened empty file):
<ul>
<li><code>:put =execute('nmap')</code> etc.</li>
</ul>
</li>
<li><code>which-key.nvim</code> also solves allow us to set timeoutlen to be short (500ms
instead of default 1000ms).
<ul>
<li><code>which-key.nvim</code> is good for dummy like me.</li>
<li>This makes <code>jk</code> for <code>&lt;Esc&gt;</code> not so clunky.</li>
</ul>
</li>
<li>keep <!-- raw HTML omitted --> and <!-- raw HTML omitted --> for internal index jumper and external file explorer</li>
</ul>
<p>Setting of <code>update-alternatives</code> settings:</p>
<ul>
<li><code>vi</code> to <code>nvim</code> (manual)</li>
<li><code>vim</code> to <code>vim.gtk3</code> (default)</li>
</ul>
<h2 id="dependency-package-management">Dependency package management</h2>
<p>Any of these packer based system, it is good idea to run followings in EX-mode
after editing the system.</p>
<pre tabindex="0"><code>:PackerSync
:PackerCompile
</code></pre><h2 id="main-configuration-management">Main configuration management</h2>
<p>In order to minimize conflict, I now use <code>git pull --rebase</code> to my local
branch.  (Probably using upstream provided interface)</p>
<ul>
<li><code>main</code> tracks <code>main</code> by <code>upstream</code> (but no push)
<ul>
<li><code>upstream</code> is set to the official site</li>
</ul>
</li>
<li><code>local</code> is rebased on <code>main</code> and commit actual used configuration with deep
modification.</li>
</ul>
<h2 id="help">help</h2>
<p>Lazy loading of packges seems to cause missing documentation.</p>
<p>See workaroun <a href="https://github.com/NTBBloodbath/doom-nvim/issues/126">https://github.com/NTBBloodbath/doom-nvim/issues/126</a></p>
<h2 id="skipped-programs">Skipped programs</h2>
<p>lazygit &ndash; go program not packaged in Debian
minimap &ndash; rust program not packaged in Debian &ndash; non-essential
neogit  &ndash; immature CLI git is good enough for me with gitsigs
suda    &ndash; <code>sudo -E</code> can start editting with vi running as user
autopairs &ndash; thank you but &hellip; I don&rsquo;t need this &quot;&quot; for &quot;</p>
<h2 id="note-on-delayed-loading">Note on delayed loading</h2>
<p>For example, <code>init.lua</code> has:</p>
<pre tabindex="0"><code>-- Load keybindings module at the end because the keybindings module cost is high
vim.defer_fn(function()
load_modules(&#34;doom.extras&#34;, { &#34;keybindings&#34; })
vim.cmd([[
  PackerLoad which-key.nvim
  silent! bufdo e
]])
end, 20)
</code></pre><ul>
<li>This uses <code>defer_fn</code> to deffer calling keybinding change code until 20 ms passes.</li>
<li>Set up <code>vim.g</code> variables for which-key.nvim.</li>
<li>Loads opt plugin which-key.nvim immediately</li>
<li>Then at the end, <code>e</code> reloads the current file and continues to edit it.</li>
</ul>
<p>Any heavy CPU/storage hungry programs can use this techniques.</p>
<h2 id="map">map</h2>
<p>For key bindings, <code>nvim-mapper</code> is used as the backend for doom-nvim.</p>
<p><code>map(mode, keys, cmd, options, category, unique_identifier, description)</code> is
used for usual <code>map(mode, keys, cmd, options)</code>.</p>
<p>Actual code looks like:</p>
<pre tabindex="0"><code>map(&#34;n&#34;, &#34;&lt;leader&gt;v&#34;, &#34;&lt;cmd&gt;w&lt;cr&gt;&#34;, opts, &#34;Save&#34;, &#34;save_left&#34;, &#34;Save v&#34;)
</code></pre><ul>
<li>Packer load nvim-mapper&rsquo;s setup() and search keybindings at path <code>~/.config/nvim/lua</code></li>
<li><code>lua/init.lua</code> &ndash;&gt; delayed &ndash;&gt; <code>lua/doom/extras/keybindings/init.lua</code></li>
</ul>
<h2 id="upstreamed-mod-for-tweak">Upstreamed mod for &ldquo;Tweak&rdquo;</h2>
<ul>
<li>Toggle/rotate  features (which-key)
<ul>
<li>number &ndash; done change_number</li>
<li>spell  &ndash; done toggle_spell</li>
<li>syntax &ndash; done change_syntax</li>
<li>git &ndash; done toggle_signcolumn</li>
<li>ale &ndash; no yet addressed</li>
<li>indent 2/4/8 &ndash; done set_indent</li>
</ul>
</li>
</ul>
<pre tabindex="0"><code>      {
        &#34;t&#34;,
        name = &#34;+tweak&#34;,
        {
          { &#34;b&#34;, require(&#34;doom.core.functions&#34;).toggle_background, name = &#34;Toggle background&#34; },
          { &#34;s&#34;, require(&#34;doom.core.functions&#34;).toggle_signcolumn, name = &#34;Toggle sigcolumn&#34; },
          { &#34;i&#34;, require(&#34;doom.core.functions&#34;).set_indent, name = &#34;Set indent&#34; },
          { &#34;n&#34;, require(&#34;doom.core.functions&#34;).change_number, name = &#34;Toggle number&#34; },
          { &#34;S&#34;, require(&#34;doom.core.functions&#34;).toggle_spell, name = &#34;Toggle spelling&#34; },
          { &#34;x&#34;, require(&#34;doom.core.functions&#34;).change_syntax, name = &#34;Toggle syntax&#34; },
        },
      },
</code></pre><h2 id="todo">TODO</h2>
<ul>
<li>ale            &ndash; shellcheck integration needed</li>
<li>Stop suggestion if CTRL-Y is pressed (same as <!-- raw HTML omitted -->.)</li>
<li><code>F6</code>-<code>F10</code>, <code>ALT</code>/<code>SHIFT</code>/<code>WIN-SPACE</code> should be off limit (used by IM)</li>
</ul>
<p>Lack of good ALE equivalent support stalled me to use neovim 0.5.</p>
<!-- raw HTML omitted -->


<table width="100%">
  <tbody>
  <tr>
  
  <td align="left" width="33%"><a href="/en/2021/08/28/git-submodule-01/">Previous Post</a></td>
  
  <td align="center" width="33%"><a href="/en/">Top</a></td>
  
  <td align="right" width="33%"><a href="/en/2021/11/02/backup-1/">Next Post</a></td>
  
  </tr>
  </tbody>
</table>

</main>

  <footer>
  
  
  <hr/>
  © 2013-2023 <a href="https://github.com/osamuaoki">Osamu Aoki</a>
  
  </footer>
  </body>
</html>

