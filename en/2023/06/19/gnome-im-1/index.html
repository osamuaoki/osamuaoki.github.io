<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>GNOME shell extension for input methods | Goofing Osamu</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    
  </head>

  <body>
    <nav>
    <ul class="menu">
      
      <li><a href="/">Home</a></li>
      
      <li><a href="/about/">About</a></li>
      
      <li><a href="/categories/">Categories</a></li>
      
      <li><a href="/tags/">Tags</a></li>
      
      <li><a href="/en/">English</a></li>
      
      <li><a href="/jp/">Japanese</a></li>
      
      <li><a href="/index.xml">Subscribe</a></li>
      
    </ul>
    <hr/>
    </nav>

<div class="article-meta">
<h1><span class="title">GNOME shell extension for input methods</span></h1>

<h3 class="date">Date:
2023/06/19 (initial publish),
2023/07/21 (last update)
</h3>
<h3 class="source">Source:
en/note-00047.md
</h3>
</div>

<main>


<table width="100%">
  <tbody>
  <tr>
  
  <td align="left" width="33%"><a href="/en/2023/06/18/gnome-tweaks-1/">Previous Post</a></td>
  
  <td align="center" width="33%"><a href="/en/">Top</a></td>
  
  <td align="right" width="33%"><a href="/en/2023/07/01/systemd-shutdown/">Next Post</a></td>
  
  </tr>
  </tbody>
</table>

<h2>TOC</h2>

<nav id="TableOfContents">
  <ul>
    <li><a href="#simple-gnome-shell-extension">Simple GNOME shell extension</a></li>
    <li><a href="#reference-examples">Reference examples</a>
      <ul>
        <li><a href="#gnome-extension-shortcuts">GNOME extension &ldquo;Shortcuts&rdquo;</a></li>
        <li><a href="#gnome-extension-more-keyboard-shortcuts">GNOME extension &ldquo;More keyboard shortcuts&rdquo;</a></li>
      </ul>
    </li>
    <li><a href="#initial-working-gnome-shell-extension-for-switching-input-methods">Initial working GNOME shell extension for switching input methods</a>
      <ul>
        <li><a href="#inputmethod-shortcuts-v1-rejected"><code>inputmethod-shortcuts</code> (v1: rejected)</a></li>
        <li><a href="#inputmethod-shortcuts-v2-rejected"><code>inputmethod-shortcuts</code> (v2: rejected)</a></li>
        <li><a href="#inputmethod-shortcuts-v3-rejected"><code>inputmethod-shortcuts</code> (v3: rejected)</a></li>
        <li><a href="#inputmethod-shortcuts-v4-accepted"><code>inputmethod-shortcuts</code> (v4: accepted)</a></li>
      </ul>
    </li>
    <li><a href="#further-improvements-of-gnome-extension-inputmethod-shortcuts-v5--v15">Further improvements of GNOME extension <code>inputmethod-shortcuts</code> (v5 &hellip; v15)</a>
      <ul>
        <li><a href="#use-of-es6-class-syntax">Use of ES6 <strong>class</strong>-syntax</a></li>
        <li><a href="#use-for-loop">Use for-loop</a></li>
        <li><a href="#add-prefsjs">Add prefs.js</a></li>
        <li><a href="#get-im-settings">Get IM settings</a></li>
        <li><a href="#control-touchpad-enabled--disabled">Control touchpad <code>enabled</code> / <code>disabled</code></a></li>
        <li><a href="#input-method-shortcuts-example-screenshot">Input Method Shortcuts (example screenshot)</a></li>
        <li><a href="#touchpad-shortcuts-example-screenshot">Touchpad Shortcuts (example screenshot)</a></li>
        <li><a href="#operation-preference-example-screenshot">Operation Preference (example screenshot)</a></li>
        <li><a href="#xkbru-interference-fix"><code>xkb=ru</code> interference fix</a></li>
        <li><a href="#add-test-keys-for-code-verification">Add <code>test-keys</code> for code verification</a></li>
        <li><a href="#use--keyvalisforbiddenkeyval">Use  <code>keyvalIsForbidden(keyval)</code></a></li>
        <li><a href="#fix-constant-calling">Fix Constant calling</a></li>
        <li><a href="#use-only-non-shift-backspace-to-delete">Use only non-SHIFT BackSpace to delete</a></li>
        <li><a href="#modifier-combos-as-shortcut">Modifier-combos as shortcut</a></li>
      </ul>
    </li>
    <li><a href="#references">References</a>
      <ul>
        <li><a href="#learning-javascript-for-gjs">Learning JavaScript for GJS</a></li>
        <li><a href="#history-and-migration-gtk3gtk4libadwaitagnome">History and migration: GTK3/GTK4/Libadwaita/GNOME</a></li>
        <li><a href="#tip-checking-systemd-log">Tip: Checking systemd log</a></li>
      </ul>
    </li>
    <li><a href="#special-character-entry">Special Character Entry</a>
      <ul>
        <li><a href="#options">Options</a></li>
        <li><a href="#input-related-special-keys">Input related special keys</a></li>
      </ul>
    </li>
  </ul>
</nav>

<p>Since I didn&rsquo;t find GNOME shell extension to provide shortcuts to input method
activations, I decided to create one by following examples of existing
extensions without rigorous learning.  I also worked on quick touchpad control.
See my final result at:</p>
<ul>
<li><a href="https://github.com/osamuaoki/inputmethod-shortcuts">Quick switching of input method and touchpad</a></li>
</ul>
<p>I also updated <a href="/en/2023/06/17/gnome-extensions-1/">GNOME extensions for better UX</a>.</p>
<h2 id="simple-gnome-shell-extension">Simple GNOME shell extension</h2>
<p>One can create a skelton of a simple GNOME shell extension as:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ gnome-shell-extension-tool --create-extension
</span></span></code></pre></div><p>This created a almost empty GNOME shell extension under
<code>~/.local/share/gnome-shell/extensions/</code>.</p>
<p>After &ldquo;Log out&rdquo; and &ldquo;Log in&rdquo; to my account, this GNOME shell extension can be
seen from &ldquo;Extensions&rdquo;.  But this was too simple to do anything useful.</p>
<h2 id="reference-examples">Reference examples</h2>
<p>Since I had no idea how to set up keybindings for switching input methods, I
looked around examples on simple GNOME extensions with &ldquo;shortcut&rdquo; as a keyword.</p>
<h3 id="gnome-extension-shortcuts">GNOME extension &ldquo;Shortcuts&rdquo;</h3>
<p>GNOME extension <a href="https://gitlab.com/paddatrapper/shortcuts-gnome-extension">Shortcuts</a>
looked like simple enough since all it does is toggling of display when <code>&lt;Super&gt;s</code> is pressed.</p>
<p>But there is no text like <code>super</code> in the source.  It looks like <code>imports.ui.main.overview</code> gets a call back to enable toggling of display.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">Main</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">imports</span>.<span style="color:#a6e22e">ui</span>.<span style="color:#a6e22e">main</span>;
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">Main</span>.<span style="color:#a6e22e">overview</span>.<span style="color:#a6e22e">_specialToggle</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">evt</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">_toggleShortcuts</span>();
</span></span><span style="display:flex;"><span>  };
</span></span></code></pre></div><p><code>gnome-shell</code> source has <code>js/ui/main.js</code> which calls <code>overview.init()</code> then <code>js/ui/overviw.js</code> which has <code>overview.init()</code> calling:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">Main</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">imports</span>.<span style="color:#a6e22e">ui</span>.<span style="color:#a6e22e">main</span>;
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Main</span>.<span style="color:#a6e22e">wm</span>.<span style="color:#a6e22e">addKeybinding</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;toggle-overview&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Gio</span>.<span style="color:#a6e22e">Settings</span>({ <span style="color:#a6e22e">schema_id</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">WindowManager</span>.<span style="color:#a6e22e">SHELL_KEYBINDINGS_SCHEMA</span> }),
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Meta</span>.<span style="color:#a6e22e">KeyBindingFlags</span>.<span style="color:#a6e22e">IGNORE_AUTOREPEAT</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Shell</span>.<span style="color:#a6e22e">ActionMode</span>.<span style="color:#a6e22e">NORMAL</span> <span style="color:#f92672">|</span> <span style="color:#a6e22e">Shell</span>.<span style="color:#a6e22e">ActionMode</span>.<span style="color:#a6e22e">OVERVIEW</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">toggle</span>.<span style="color:#a6e22e">bind</span>(<span style="color:#66d9ef">this</span>));
</span></span></code></pre></div><p>In <code>data/org.gnome.shell.gschema.xml.in</code> from <code>gnome-shell</code> source, I found:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;key</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;toggle-overview&#34;</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#34;as&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>│ <span style="color:#f92672">&lt;default&gt;</span>[&#34;&amp;lt;Super&amp;gt;s&#34;]<span style="color:#f92672">&lt;/default&gt;</span>
</span></span><span style="display:flex;"><span>│ <span style="color:#f92672">&lt;summary&gt;</span>Keybinding to open the overview<span style="color:#f92672">&lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>│ <span style="color:#f92672">&lt;description&gt;</span>
</span></span><span style="display:flex;"><span>│ │ Keybinding to open the Activities Overview.
</span></span><span style="display:flex;"><span>│ <span style="color:#f92672">&lt;/description&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/key&gt;</span>
</span></span></code></pre></div><p>So basically, this extension uses keybinding defined by <code>gnome-shell</code>.</p>
<p>The schema definition <code>&lt;default&gt;[&quot;&amp;lt;Super&amp;gt;s&quot;]&lt;/default&gt;</code> used in
<code>data/org.gnome.shell.gschema.xml.in</code> is interesting. Also,
<code>imports.ui.main.wm.addKeybinding()</code> seems to be the way to bind specific key
to a JavaScript code.</p>
<p>I also got idea to use <strong>IGNORE_AUTOREPEAT</strong> from this.</p>
<h3 id="gnome-extension-more-keyboard-shortcuts">GNOME extension &ldquo;More keyboard shortcuts&rdquo;</h3>
<p><a href="https://github.com/matthijskooijman/gnome-shell-more-keyboard-shortcuts">More keyboard shortcuts</a>
also looked like simple enough since all it does is
switching window on the current workspace
when <code>&lt;Super&gt;j</code>  or <code>&lt;Super&gt;k</code> is pressed.</p>
<p>This source has its own <code>schemas/org.gnome.shell.extensions.more-keyboard-shortcuts.gschema.xml</code> with <code>&lt;default&gt;&lt;![CDATA[['&lt;Super&gt;j']]]&gt;&lt;/default&gt;</code> and <code>&lt;default&gt;&lt;![CDATA[['&lt;Super&gt;k']]]&gt;&lt;/default&gt;</code> for <code>&lt;key type=&quot;as&quot; name=&quot;switch-window-next-workspace&quot;&gt;</code> and <code>&lt;key type=&quot;as&quot; name=&quot;switch-window-prev-workspace&quot;&gt;</code>.</p>
<p>I suppose this <code>CDATA</code> thing is the same thing as <code>&lt;default&gt;[&quot;&amp;lt;Super&amp;gt;j&quot;]&lt;/default&gt;</code> and <code>&lt;default&gt;[&quot;&amp;lt;Super&amp;gt;k&quot;]&lt;/default&gt;</code>.</p>
<p>I also see <code>extension.js</code> has the following which binds &ldquo;key name&rdquo; to JavaScript.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">enable</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Main</span>.<span style="color:#a6e22e">wm</span>.<span style="color:#a6e22e">addKeybinding</span>(<span style="color:#e6db74">&#34;switch-window-next-workspace&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">settings</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">Meta</span>.<span style="color:#a6e22e">KeyBindingFlags</span>.<span style="color:#a6e22e">NONE</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">Shell</span>.<span style="color:#a6e22e">ActionMode</span> <span style="color:#f92672">?</span> <span style="color:#a6e22e">Shell</span>.<span style="color:#a6e22e">ActionMode</span>.<span style="color:#a6e22e">NORMAL</span> <span style="color:#f92672">:</span> <span style="color:#a6e22e">Shell</span>.<span style="color:#a6e22e">KeyBindingMode</span>.<span style="color:#a6e22e">NORMAL</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">display</span>, <span style="color:#a6e22e">screen</span>, window, <span style="color:#a6e22e">binding</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">switchWindow</span>(<span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Main</span>.<span style="color:#a6e22e">wm</span>.<span style="color:#a6e22e">addKeybinding</span>(<span style="color:#e6db74">&#34;switch-window-prev-workspace&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">settings</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">Meta</span>.<span style="color:#a6e22e">KeyBindingFlags</span>.<span style="color:#a6e22e">NONE</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">Shell</span>.<span style="color:#a6e22e">ActionMode</span> <span style="color:#f92672">?</span> <span style="color:#a6e22e">Shell</span>.<span style="color:#a6e22e">ActionMode</span>.<span style="color:#a6e22e">NORMAL</span> <span style="color:#f92672">:</span> <span style="color:#a6e22e">Shell</span>.<span style="color:#a6e22e">KeyBindingMode</span>.<span style="color:#a6e22e">NORMAL</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">display</span>, <span style="color:#a6e22e">screen</span>, window, <span style="color:#a6e22e">binding</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">switchWindow</span>(<span style="color:#66d9ef">false</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>By replacing <code>switchWindow()</code> with Input Method setting JavaScript function, I
think I can get desired extension functionality.</p>
<p>Since this was my first JavaScript program, there were many rough edges.</p>
<h2 id="initial-working-gnome-shell-extension-for-switching-input-methods">Initial working GNOME shell extension for switching input methods</h2>
<p>I then went to upload a zip file of this newly made extension to GNOME site.
It became very interesting learning experiences.</p>
<h3 id="inputmethod-shortcuts-v1-rejected"><code>inputmethod-shortcuts</code> (v1: rejected)</h3>
<p><strong>JustPerfection</strong> gave me feed backs.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>OsamuAoki&#39;s extension, &#34;Shortcuts to activate input methods&#34;, version 1 has a new review:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>JustPerfection posted a review on June 25, 2023:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>1. Please remove `stylesheet.css` since you are not using it:
</span></span><span style="display:flex;"><span>    https://gjs.guide/extensions/review-guidelines/review-guidelines.html#don-t-include-unnecessary-files
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>2. Remove versions &amp;gt;=45 since we don&amp;#x27;t have those versions yet.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>3. Use initTranslations() and getSettings() from ExtensionUtils instead of creating your own custom functions (remove convenience.js after that):
</span></span><span style="display:flex;"><span>    https://gitlab.gnome.org/GNOME/gnome-shell/-/blob/main/js/misc/extensionUtils.js
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>4. That&amp;#x27;s too much for init (line 42 extension.js):
</span></span><span style="display:flex;"><span>    https://gjs.guide/extensions/review-guidelines/review-guidelines.html#only-use-init-for-initialization
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Move that line to enable and null that out in disable:
</span></span><span style="display:flex;"><span>    https://gjs.guide/extensions/review-guidelines/review-guidelines.html#destroy-all-objects
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>5. Remove all the key bindings on disable (line 118-149 extension.js).
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>If you need any help with your extension you can ask us on:
</span></span><span style="display:flex;"><span>- [GNOME Matrix Channel](https://matrix.to/#/#extensions:gnome.org)
</span></span><span style="display:flex;"><span>- IRC Bridge: irc://irc.gimpnet.org/shell-extensions
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Please use the review page to follow up:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>https://extensions.gnome.org/review/42618
</span></span></code></pre></div><p>This was very helpful.  I thought I fixed them all but (I forgot to erase old
zip in the source tree.)  I uploaded again.</p>
<h3 id="inputmethod-shortcuts-v2-rejected"><code>inputmethod-shortcuts</code> (v2: rejected)</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>OsamuAoki&#39;s extension, &#34;Shortcuts to activate input methods&#34;, version 2 has a new review:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>JustPerfection posted a review on June 25, 2023:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>1. You forgot to remove `stylesheet.css` and `convenience.js`.
</span></span><span style="display:flex;"><span>2. As I said before, you should null out `settings` in disable.
</span></span><span style="display:flex;"><span>3. I recommend to Import in top of the code instead of inside enable (line 51, 60, 69 and 78 extension.js).
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Please use the review page to follow up:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>https://extensions.gnome.org/review/42621
</span></span><span style="display:flex;"><span>OsamuAoki&#39;s extension, &#34;Shortcuts to activate input methods&#34;, version 2 has a new review:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>JustPerfection posted a review on June 25, 2023:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>1. You forgot to remove `stylesheet.css` and `convenience.js`.
</span></span><span style="display:flex;"><span>2. As I said before, you should null out `settings` in disable.
</span></span><span style="display:flex;"><span>3. I recommend to Import in top of the code instead of inside enable (line 51, 60, 69 and 78 extension.js).
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Please use the review page to follow up:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>https://extensions.gnome.org/review/42621
</span></span></code></pre></div><p>Very kind words on careless newbie.</p>
<h3 id="inputmethod-shortcuts-v3-rejected"><code>inputmethod-shortcuts</code> (v3: rejected)</h3>
<p>I missed issue 2 pointed out for version 2.  So I uploaded another one before
getting official rejection.</p>
<h3 id="inputmethod-shortcuts-v4-accepted"><code>inputmethod-shortcuts</code> (v4: accepted)</h3>
<p>This got accepted.  (I saw some minor issues and fixed them in git repo,
later.)</p>
<h2 id="further-improvements-of-gnome-extension-inputmethod-shortcuts-v5--v15">Further improvements of GNOME extension <code>inputmethod-shortcuts</code> (v5 &hellip; v15)</h2>
<p>I explored more refactoring of code and feature additions to support
shortcut configuration.</p>
<h3 id="use-of-es6-class-syntax">Use of ES6 <strong>class</strong>-syntax</h3>
<p>Both ES5 prototype-syntax and ES6 class-syntax offer OOP features, but ES6
class-syntax is less confusing for me.  So I decided to rewite
<code>inputmethod-shortcuts</code> using ES6 class-syntax.  &ndash; done</p>
<h3 id="use-for-loop">Use for-loop</h3>
<p>Repeating codes looks stupid.  So I added for-loop. &ndash; done</p>
<h3 id="add-prefsjs">Add prefs.js</h3>
<p>Make shortcut key choice configurable. &ndash; done</p>
<h3 id="get-im-settings">Get IM settings</h3>
<p>Use <code>Gio</code> -&gt; <code>Settings</code> &ndash; done</p>
<p>So IM names are displayed and their shortcuts are configurable up to 10.</p>
<p><img src="/img/InputMethods.png" alt="prefs.js"></p>
<p>This UI will be updated later as below with markups.</p>
<h3 id="control-touchpad-enabled--disabled">Control touchpad <code>enabled</code> / <code>disabled</code></h3>
<p>Since the following shell code lines turn on/off touchpad:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ gsettings set org.gnome.desktop.peripherals.touchpad send-events enabled
</span></span><span style="display:flex;"><span>$ gsettings set org.gnome.desktop.peripherals.touchpad send-events disabled
</span></span></code></pre></div><p>I tried the same thing in <code>gjs-console</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">gjs</span><span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">Touchpad</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">imports</span>.<span style="color:#a6e22e">gi</span>.<span style="color:#a6e22e">Gio</span>.<span style="color:#a6e22e">Settings</span>({ <span style="color:#a6e22e">schema_id</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;org.gnome.desktop.peripherals.touchpad&#39;</span> })
</span></span><span style="display:flex;"><span>[<span style="color:#a6e22e">object</span> <span style="color:#a6e22e">instance</span> <span style="color:#a6e22e">wrapper</span> <span style="color:#a6e22e">GIName</span><span style="color:#f92672">:</span><span style="color:#a6e22e">Gio</span>.<span style="color:#a6e22e">Settings</span> <span style="color:#a6e22e">jsobj</span><span style="color:#960050;background-color:#1e0010">@</span><span style="color:#ae81ff">0x36b95d5f5b8</span> <span style="color:#66d9ef">native</span><span style="color:#960050;background-color:#1e0010">@</span><span style="color:#ae81ff">0x7fee6000fc60</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">gjs</span><span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">Touchpad</span>.<span style="color:#a6e22e">get_value</span>(<span style="color:#e6db74">&#34;send-events&#34;</span>)
</span></span><span style="display:flex;"><span>[<span style="color:#a6e22e">object</span> <span style="color:#a6e22e">variant</span> <span style="color:#66d9ef">of</span> <span style="color:#a6e22e">type</span> <span style="color:#e6db74">&#34;s&#34;</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">gjs</span><span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">Touchpad</span>.<span style="color:#a6e22e">get_string</span>(<span style="color:#e6db74">&#34;send-events&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;disabled&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">gjs</span><span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">Touchpad</span>.<span style="color:#a6e22e">set_string</span>(<span style="color:#e6db74">&#34;send-events&#34;</span>, <span style="color:#e6db74">&#34;enabled&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">gjs</span><span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">Touchpad</span>.<span style="color:#a6e22e">set_string</span>(<span style="color:#e6db74">&#34;send-events&#34;</span>, <span style="color:#e6db74">&#34;disabled&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">true</span>
</span></span></code></pre></div><p>I refactored <code>prefs.js</code> and added touchpad control shortcuts.</p>
<p>NOTE: Media key for touchpad seems to cause pop-up icons displayed without
changes to the touchpad state.
(schema=<code>org.gnome.settings-daemon.plugins.media-keys</code>, key=<code>touchpad-on</code>)</p>
<h3 id="input-method-shortcuts-example-screenshot">Input Method Shortcuts (example screenshot)</h3>
<p>Here is the updated UI with markups.</p>
<p><img src="/img/pref-im.png" alt="InputMethod Shortcuts"></p>
<p>Here, I disabled <code>&lt;Super&gt;Space</code> and <code>&lt;Super&gt;&lt;Shift&gt;Space</code> usages in &ldquo;Settings&rdquo;
-&gt; &ldquo;Keyboard&rdquo; -&gt; &ldquo;Keyboard shortcuts&rdquo; -&gt; &ldquo;Typing&rdquo; before setting up as above.</p>
<p>Please note that, if an ibus can offer its internal shortcuts to activate input
method engine (IME) and to deactivate IME by using direct input mode just with
xkb for latin character set, switching between IME and direct input mode within
ibus is quicker than using Desktop based input method switching functionality
handled by this extension.</p>
<h3 id="touchpad-shortcuts-example-screenshot">Touchpad Shortcuts (example screenshot)</h3>
<p><img src="/img/pref-tp.png" alt="Touchpad Shortcuts"></p>
<p>Please note that you don&rsquo;t need to set all shortcut bindings.</p>
<h3 id="operation-preference-example-screenshot">Operation Preference (example screenshot)</h3>
<p><img src="/img/pref-op.png" alt="Operation Preference"></p>
<h3 id="xkbru-interference-fix"><code>xkb=ru</code> interference fix</h3>
<p>Normal ibus-based input methods break when they are invoked after using
<code>xkb=ru</code>.  In order to reduce shortcut key presses, I added feature to go
through the primary xkb before invoking any ibus.</p>
<h3 id="add-test-keys-for-code-verification">Add <code>test-keys</code> for code verification</h3>
<p>I created dummy extension to test code snippets to debug code</p>
<h3 id="use--keyvalisforbiddenkeyval">Use  <code>keyvalIsForbidden(keyval)</code></h3>
<p>Force to avoid cursor and return keys.</p>
<h3 id="fix-constant-calling">Fix Constant calling</h3>
<pre tabindex="0"><code>-    if ((mask === 0 || mask === Gdk.SHIFT_MASK) &amp;&amp; keycode !== 0) {
+    if ((mask === 0 || mask === Gdk.ModifierType.SHIFT_MASK) &amp;&amp; keycode !== 0) {
</code></pre><h3 id="use-only-non-shift-backspace-to-delete">Use only non-SHIFT BackSpace to delete</h3>
<pre tabindex="0"><code>-            if (keyval === Gdk.KEY_BackSpace) {
+            if (mask === 0 &amp;&amp; keyval === Gdk.KEY_BackSpace) {
</code></pre><h3 id="modifier-combos-as-shortcut">Modifier-combos as shortcut</h3>
<p>There are some odd key code:</p>
<ul>
<li><code>Shift-Alt_L</code> pressed &ndash;&gt; <code>&lt;Shift&gt;Meta_L</code> generated</li>
<li><code>Control-Alt_L</code> pressed &ndash;&gt; <code>&lt;Control&gt;Alt_L</code> generated</li>
</ul>
<p>So adding feature to register Modifier-combos as shortcut was a bit tricky.</p>
<p><img src="/img/pref-im-alt.png" alt="prefs-im-alt.js"></p>
<p>(Including Alt and AltGr in combo was not the best idea since their keysym
isn&rsquo;t stable.)</p>
<p>So I use now:</p>
<p><img src="/img/pref-im-alt.png" alt="prefs-im-alt2.js"></p>
<h2 id="references">References</h2>
<h3 id="learning-javascript-for-gjs">Learning JavaScript for GJS</h3>
<p>When I started to write GJS JavaScript code for this extension, I had no idea
on JavaScript except it is a interpreter with C/C++-like syntax. Here is a
list of reference documents I decided to read to understand JavaScript and its
use for GNOME.</p>
<ul>
<li>Wikipedia: <a href="s://en.wikipedia.org/wiki/JavaScript">JavaScript</a></li>
<li>Wikipedia: <a href="https://en.wikipedia.org/wiki/ECMAScript">ECMAScript</a></li>
<li>MDN: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript">JavaScript</a></li>
<li><a href="https://gjs.guide/">A Guide to JavaScript for GNOME</a>
<ul>
<li><a href="https://gjs.guide/guides/">Developer Guides</a>
<ul>
<li><a href="https://gjs.guide/guides/gjs/intro.html">GNOME JavaScript Introduction</a></li>
<li><a href="https://gjs.guide/guides/gjs/features-across-versions.html">Feature Compatibility</a></li>
<li><a href="https://gjs.guide/guides/gjs/legacy-class-syntax.html">GJS Legacy Class Syntax</a></li>
<li><a href="https://gjs.guide/guides/gjs/style-guide.html">GJS Style Guide</a></li>
</ul>
</li>
<li><a href="https://gjs.guide/extensions/">GNOME Shell Extensions</a></li>
<li><a href="https://gjs-docs.gnome.org/javascript/">JavaScript reference</a></li>
</ul>
</li>
</ul>
<p>JavaScript versions were confusing to me.  Major versions are:</p>
<ul>
<li>ES5: ECMAScript 5 (2009)</li>
<li>ES6: ECMAScript 6 (2015)</li>
</ul>
<p>I also find a nice summary of generic style equivalences of ES5 and ES6 at
<a href="https://www.w3schools.com/js/js_es6.asp">w3schools.com site for JavaScript</a>.</p>
<h3 id="history-and-migration-gtk3gtk4libadwaitagnome">History and migration: GTK3/GTK4/Libadwaita/GNOME</h3>
<p>Following references helped me to orient myself what is going on.</p>
<ul>
<li>GNOME History
<ul>
<li><a href="https://adrienplazas.com/blog/2021/03/31/introducing-libadwaita.html">Introducing Libadwaita (2021-03-31)</a> &ndash; Adrien Plazas</li>
<li><a href="https://help.gnome.org/misc/release-notes/41.0/">Introducing GNOME 41 (2021-09-22)</a> &ndash; GNOME</li>
<li><a href="https://release.gnome.org/42/">Introducing GNOME 42 (2022-03-23)</a> &ndash; GNOME</li>
<li><a href="https://blogs.gnome.org/christopherdavis/2022/04/03/plans-for-gnome-43-and-beyond/?ref=news.itsfoss.com">Plans for GNOME 43 and Beyond (2022-04-03)</a> &ndash; CHRIS DAVIS</li>
<li><a href="https://theevilskeleton.gitlab.io/2022/07/28/libadwaita-fixing-usability-problems-on-the-linux-desktop.html">libadwaita: Fixing Usability Problems on the Linux Desktop (2022-07-28)</a> &ndash; Hari Rana</li>
<li><a href="https://release.gnome.org/43/">Introducing GNOME 43, “Guadalajara” (2022-09-21)</a> &ndash; GNOME</li>
<li><a href="https://blog.gtk.org/2023/02/09/updates-from-inside-gtk/">Updates from inside GTK (2023-02-09)</a> &ndash; GTK Development Blog</li>
<li><a href="https://release.gnome.org/44/">Introducing GNOME 44, “Kuala Lumpur” (2023-03-22)</a> &ndash; GNOME</li>
</ul>
</li>
<li>GUI RAD for GTK4 (Glade successor)
<ul>
<li><a href="https://blogs.gnome.org/christopherdavis/2020/11/19/glade-not-recommended/">Glade Not Recommended (2020-11-19)</a> &ndash; CHRIS DAVIS</li>
<li><a href="https://discourse.gnome.org/t/plan-about-gtk4-support-of-glade/5965">Plan about GTK4 support of Glade? (2021-03-19)</a></li>
<li><a href="https://events.gnome.org/event/9/contributions/191/">Cambalache UI Maker (2021-07-21)</a> &ndash; GUADEC by Juan Pablo Ugarte</li>
<li><a href="https://blogs.gnome.org/xjuan/2023/06/16/cambalache-0-12-0-released/">Cambalache 0.12.0 Released! (2023-06-16)</a> &ndash; by Juan Pablo Ugarte</li>
<li><a href="https://gitlab.gnome.org/jpu/cambalache">Cambalach</a> &ndash; GNOME GITLAB</li>
<li><a href="https://flathub.org/apps/ar.xjuan.Cambalache">Cambalach</a> &ndash; <a href="https://flathub.org/">flathub.org</a> &ndash; by Juan Pablo Ugarte</li>
</ul>
</li>
<li>Gradience &ndash; a tool for customizing Libadwaita applications and the adw-gtk3 theme
<ul>
<li><a href="https://github.com/GradienceTeam/Gradience">Gradience</a> &ndash; GITHUB</li>
<li><a href="https://flathub.org/apps/com.github.GradienceTeam.Gradience">Gradience</a> &ndash; Flathub</li>
</ul>
</li>
<li>Migration
<ul>
<li><a href="https://docs.gtk.org/gtk4/migrating-3to4.html">Migrating from GTK 3.x to GTK 4</a></li>
<li><a href="https://gnome.pages.gitlab.gnome.org/libadwaita/doc/main/migrating-libhandy-1-4-to-libadwaita.html">Migrating from Libhandy 1.4 to Libadwaita</a></li>
</ul>
</li>
</ul>
<p>Since Debian bookworm/12 is GNOME 43, it seems good idea to use GTK4 with
Libadwaita.</p>
<p>Also, any new applications which are missing on host system, such as newer
Shotwell (0.32.1) which supports HEIF and Cambalach for GTK4 GUI design, are
best installed via flatpak.</p>
<h3 id="tip-checking-systemd-log">Tip: Checking systemd log</h3>
<p>I can see all <strong>gnome-shell</strong> log including DEBUG output from the last system
boot as:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ journalctl -p <span style="color:#ae81ff">7</span> -b -g gnome-shell
</span></span></code></pre></div><ul>
<li>Use <code>-g gjs</code> for <code>prefs.js</code>.</li>
<li>Use <code>-f</code> instead of <code>-b</code> to monitor continuously.</li>
</ul>
<h2 id="special-character-entry">Special Character Entry</h2>
<h3 id="options">Options</h3>
<p>Conclusion: Use &ldquo;US, intl., with AltGr dead keys&rdquo;</p>
<p>Rationale:</p>
<p>There are 2 ways to enter special non-ASCII characters under en_US.UTF-8.</p>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Compose_key">Compose</a> &ndash; Unix/X legacy
<ul>
<li><a href="https://www.x.org/releases/current/doc/libX11/i18n/compose/en_US.UTF-8.html">Xlib Compose Keys for en_US.UTF-8</a></li>
<li><a href="https://tstarling.com/stuff/ComposeKeys.html">Linux Compose Key Sequences</a></li>
<li>This requires to assign a key to generate keysym=<code>KEY_Meta</code>.
<ul>
<li>Assign a key with keysym=<code>KEY_Multi_key</code> using: GNOME <code>Settings</code> -&gt; <code>Keyboard</code> -&gt; <code>Special Character Entry</code> -&gt; <code>Compose Key</code></li>
<li>This key assignment may be done with xkb command.</li>
</ul>
</li>
<li>This conversion functionality itself works without xkb support.  (This can be used even under xkb=<code>en</code>)</li>
</ul>
</li>
<li><a href="https://en.wikipedia.org/wiki/AltGr_key">AltGr</a>
<ul>
<li>IBM/PC legacy offering 4 keysyms per each key (Normal/Shift/AltGr/Shift-AltGr)
<ul>
<li><code>KEY_ISO_LEVEL3_Shift</code> on Linux offfers AltGr=<code>KEY_Alt_R</code> functionality</li>
<li>Assign a key with keysym=<code>KEY_ISO_LEVEL3_Shift</code> using: GNOME <code>Settings</code> -&gt; <code>Keyboard</code> -&gt; <code>Special Character Entry</code> -&gt; <code>Alternate Characters Key</code></li>
</ul>
</li>
<li>US, intl., with AltGr <a href="https://en.wikipedia.org/wiki/Dead_key">dead keys</a>
<ul>
<li><strong>Preferred variant</strong> on Linux</li>
<li>dead keys require AltGr pressed together</li>
<li>Compose-key like capability without loss of normal us key experience</li>
<li>This functionality is also available on Windows from third parties. <a href="https://github.com/thomasfaingnaert/win-us-intl-altgr">1</a>, <a href="https://www.scottseverance.us/html/keyboard/win_intl_altgr/">2</a></li>
</ul>
</li>
<li>US, intl., with <a href="https://en.wikipedia.org/wiki/Dead_key">dead keys</a>
<ul>
<li>Variant which functions exactly same as Windows &ldquo;United States (International)&rdquo; layout</li>
<li>This interferes with entering some punctuation keys.</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><a href="https://unix.stackexchange.com/questions/55076/what-is-the-mode-switch-modifier-for">The meaning of AltGr is discussed on stackexchange in details</a>.</p>
<ul>
<li>&ldquo;Mode_switch&rdquo; is the old-style (pre-XKB) name of the key that is called AltGr on many keyboard layouts.</li>
<li>&ldquo;ISO_Level3_Shift&rdquo; is the XKB version of this key.</li>
</ul>
<h3 id="input-related-special-keys">Input related special keys</h3>
<ul>
<li>Linux:
<ul>
<li>AltGr: default for generating <code>KEY_ISO_LEVEL3_Shift</code> effects.  This also
changes keysym depending on its invocation situation.</li>
<li>Super-space: default GNOME input source forward rotating</li>
<li>Super-shift-space: default GNOME input source backward rotating</li>
<li>Shift-space: switch input method on/off &mdash; old style</li>
<li>Control-space: switch input method on/off &mdash; old style</li>
</ul>
</li>
<li>Windows
<ul>
<li>Control-Shift: change input language/layout</li>
<li>Shift-Alt:     change input language/layout</li>
<li>Kanji: switch input method on/off &mdash; old style</li>
<li>Windows-space: default input source forward rotating</li>
<li>Windows-shift-space: default input source backward rotating</li>
</ul>
</li>
</ul>
<!-- raw HTML omitted -->


<table width="100%">
  <tbody>
  <tr>
  
  <td align="left" width="33%"><a href="/en/2023/06/18/gnome-tweaks-1/">Previous Post</a></td>
  
  <td align="center" width="33%"><a href="/en/">Top</a></td>
  
  <td align="right" width="33%"><a href="/en/2023/07/01/systemd-shutdown/">Next Post</a></td>
  
  </tr>
  </tbody>
</table>

</main>

  <footer>
  
  
  <hr/>
  © 2013-2023 <a href="https://github.com/osamuaoki">Osamu Aoki</a>
  
  </footer>
  </body>
</html>

