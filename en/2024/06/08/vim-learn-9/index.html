<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Re-learning Vim (9) | Goofing Osamu</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    
  </head>

  <body>
    <nav>
    <ul class="menu">
      
      <li><a href="/">Home</a></li>
      
      <li><a href="/about/">About</a></li>
      
      <li><a href="/categories/">Categories</a></li>
      
      <li><a href="/tags/">Tags</a></li>
      
      <li><a href="/en/">English</a></li>
      
      <li><a href="/jp/">Japanese</a></li>
      
      <li><a href="/index.xml">Subscribe</a></li>
      
    </ul>
    <hr/>
    </nav>

<div class="article-meta">
<h1><span class="title">Re-learning Vim (9)</span></h1>

<h3 class="date">Date:
2024/06/08 (initial publish),
2024/06/13 (last update)
</h3>
<h3 class="source">Source:
en/note-00075.md
</h3>
</div>

<main>


<table width="100%">
  <tbody>
  <tr>
  
  <td align="left" width="33%"><a href="/en/2024/06/04/vim-learn-8/">Previous Post</a></td>
  
  <td align="center" width="33%"><a href="/en/">Top</a></td>
  
  <td align="right" width="33%"><a href="#">***</a></td>
  
  </tr>
  </tbody>
</table>

<h2>TOC</h2>

<nav id="TableOfContents">
  <ul>
    <li><a href="#an-example-c-program-with-makefile">An example C program with Makefile</a></li>
    <li><a href="#jump-to-errors-in-the-source-code-c-program-example-with-quickfix">Jump to errors in the source code: C program example with quickfix</a></li>
    <li><a href="#inspect-running-program-direct-gdb">Inspect running program (direct GDB)</a></li>
    <li><a href="#inspect-running-program-remote-gdb">Inspect running program (remote GDB)</a></li>
    <li><a href="#inspect-running-program-via-dap">Inspect running program (via DAP)</a></li>
    <li><a href="#jump-to-the-specific-position-in-a-file-generic-vim">Jump to the specific position in a file: generic Vim</a></li>
    <li><a href="#my-todo-list">My TODO list</a></li>
  </ul>
</nav>

<h2 id="an-example-c-program-with-makefile">An example C program with Makefile</h2>
<p>In order to practice with a simple C program, I created <a href="https://github.com/osamuaoki/osamuaoki-hugo-proj/tree/master/021_gcc_debug"><code>test.c</code> and <code>Makefile</code>
at github</a>.</p>
<p>Let me recap basic GCC options used in this example together with some popular
situation.</p>
<ul>
<li>CPP
<ul>
<li><code>-D_FORTIFY_SOURCE=2</code>: add checks for buffer overflows via CPP
(pre-processor)
<ul>
<li>GCC warns for unused return value for function such as <code>scanf(...)</code> with
this.</li>
</ul>
</li>
</ul>
</li>
<li>GCC optimization
<ul>
<li><code>-O0</code>: default optimization if not specified -&gt; May yield uninitialized variable memory</li>
<li><code>-Og</code>: optimization for debug</li>
<li><code>-O2</code>: optimization for normal use</li>
</ul>
</li>
<li>GCC warning
<ul>
<li><code>-Wall</code>: Enable every warning</li>
<li><code>-Werror</code>: Error for warning</li>
<li><code>-g</code>: Produce debug symbol in the operating system&rsquo;s native format (GDB compatible)</li>
<li><code>-ggdb</code>: Produce debug symbol by GDB (with extra data)</li>
</ul>
</li>
<li>Other GCC notable options</li>
<li><code>-E</code>: Get the preprocessor output only</li>
<li><code>-S</code>: Get the assembly code</li>
<li><code>-V</code>: Get the verbose output of compilation</li>
<li><code>-fPIC</code>: Get a position-independent code</li>
<li><code>-Wl,option</code>: Linker option
<ul>
<li><code>-Wl,-z,relo</code>: pass <code>-z relo</code> to LD.</li>
</ul>
</li>
<li>LD (linker) option
<ul>
<li><code>-l</code>: Link with a shared library
<ul>
<li><code>-lm</code>: link with math library</li>
</ul>
</li>
<li><code>-L</code>: Specify the location of the external library</li>
<li><code>-z relro</code>: memory segment made read-only after relocation</li>
</ul>
</li>
</ul>
<p>Uninitialized variable was zeroed by code generated by <code>-Og</code> and <code>-O2</code> but not
by <code>-O0</code>. So I should use <code>-O2</code> or <code>-Og</code> to make debug easy.</p>
<h2 id="jump-to-errors-in-the-source-code-c-program-example-with-quickfix">Jump to errors in the source code: C program example with quickfix</h2>
<p>Above example compiles without issue.  So let me intensionally break it by
removing <code>;</code> in some lines by editing with:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>$ vi test.c
</span></span></code></pre></div><p>While in Nvim, let me type <code>:make</code> in NORMAL mode.  This runs the content of
<code>Makefile</code> with <code>make</code>.  It sure causes errors and the cursor moves to the
first error position. I can jump around errors with <code>[q</code> and <code>]q</code>.  Cool.</p>
<p>I can also open quickfix list window with <code>:copen</code>.</p>
<p>Pressing ENTER on quickfix list window line jumps cursor to its corresponding
position.</p>
<h2 id="inspect-running-program-direct-gdb">Inspect running program (direct GDB)</h2>
<p>Use of GDB was touched in <a href="/en/2013/08/12/fun2prog-debug-3/">Fun to Program – Debug: level 3</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>$ make
</span></span><span style="display:flex;"><span>$ gdb -q ./test
</span></span><span style="display:flex;"><span>Reading symbols from ./test...
</span></span><span style="display:flex;"><span>(gdb) list 1,15
</span></span><span style="display:flex;"><span>1	#include &lt;stdlib.h&gt;
</span></span><span style="display:flex;"><span>2	#include &lt;stdio.h&gt;
</span></span><span style="display:flex;"><span>3	int main() {
</span></span><span style="display:flex;"><span>4	  int i, final, factorial = 1;
</span></span><span style="display:flex;"><span>5	  printf(&#34;Enter the number: &#34;);
</span></span><span style="display:flex;"><span>6	  if (scanf(&#34;%d&#34;, &amp;final)) {
</span></span><span style="display:flex;"><span>7	    for (i = 1; i &lt;= final; i++)
</span></span><span style="display:flex;"><span>8	      factorial = factorial * i;
</span></span><span style="display:flex;"><span>9	    printf(&#34;The factorial of %d is %d\n&#34;, final, factorial);
</span></span><span style="display:flex;"><span>10	    exit(0);
</span></span><span style="display:flex;"><span>11	  } else {
</span></span><span style="display:flex;"><span>12	    exit(1);
</span></span><span style="display:flex;"><span>13	  }
</span></span><span style="display:flex;"><span>14	}
</span></span><span style="display:flex;"><span>(gdb) b 8
</span></span><span style="display:flex;"><span>Breakpoint 1 at 0x1199: file test.c, line 8.
</span></span><span style="display:flex;"><span>(gdb) run
</span></span><span style="display:flex;"><span>Starting program: /home/osamu/github/osamuaoki.github.io/osamuaoki-hugo-proj/021_gcc_debug/test
</span></span><span style="display:flex;"><span>[Thread debugging using libthread_db enabled]
</span></span><span style="display:flex;"><span>Using host libthread_db library &#34;/lib/x86_64-linux-gnu/libthread_db.so.1&#34;.
</span></span><span style="display:flex;"><span>Enter the number: 17
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>Breakpoint 1, main () at test.c:8
</span></span><span style="display:flex;"><span>8	      factorial = factorial * i;
</span></span><span style="display:flex;"><span>(gdb) info locals
</span></span><span style="display:flex;"><span>i = 1
</span></span><span style="display:flex;"><span>final = 17
</span></span><span style="display:flex;"><span>factorial = 1
</span></span><span style="display:flex;"><span>(gdb) c 16
</span></span><span style="display:flex;"><span>Will ignore next 15 crossings of breakpoint 1.  Continuing.
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>Breakpoint 1, main () at test.c:8
</span></span><span style="display:flex;"><span>8	      factorial = factorial * i;
</span></span><span style="display:flex;"><span>(gdb) info locals
</span></span><span style="display:flex;"><span>i = 17
</span></span><span style="display:flex;"><span>final = 17
</span></span><span style="display:flex;"><span>factorial = 2004189184
</span></span><span style="display:flex;"><span>(gdb) n
</span></span><span style="display:flex;"><span>7	    for (i = 1; i &lt;= final; i++)
</span></span><span style="display:flex;"><span>(gdb) n
</span></span><span style="display:flex;"><span>9	    printf(&#34;The factorial of %d is %d\n&#34;, final, factorial);
</span></span><span style="display:flex;"><span>(gdb) info locals
</span></span><span style="display:flex;"><span>i = 18
</span></span><span style="display:flex;"><span>final = 17
</span></span><span style="display:flex;"><span>factorial = -288522240
</span></span><span style="display:flex;"><span>(gdb) n
</span></span><span style="display:flex;"><span>The factorial of 17 is -288522240
</span></span><span style="display:flex;"><span>10	    exit(0);
</span></span><span style="display:flex;"><span>(gdb) c
</span></span><span style="display:flex;"><span>Continuing.
</span></span><span style="display:flex;"><span>[Inferior 1 (process 72091) exited normally]
</span></span></code></pre></div><p>Since 17 * 2,004,189,184 =  36,507,221,999, and <code>int</code> is 32 bit signed integer,  overflow occurred (max = 0x7FFF_FFFF= 2,147,483,647).</p>
<h2 id="inspect-running-program-remote-gdb">Inspect running program (remote GDB)</h2>
<p>Let&rsquo;s think about simple single host with 2 terminal console case.</p>
<p>On console GDBSERVER (remote), let&rsquo;s start <code>gdbserver</code> to test <code>./test</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>$ gdbserver localhost:1234 ./test
</span></span><span style="display:flex;"><span>Process ./test created; pid = 32761
</span></span><span style="display:flex;"><span>Listening on port 1234
</span></span></code></pre></div><p>On console GDB (local), start <code>gdb</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>$ gdb -q
</span></span><span style="display:flex;"><span>(gdb) target remote localhost:1234
</span></span><span style="display:flex;"><span>(gdb) b 7
</span></span><span style="display:flex;"><span>Breakpoint 1 at 0x55555555519c: file test.c, line 7.
</span></span><span style="display:flex;"><span>(gdb) c
</span></span><span style="display:flex;"><span>Continuing.
</span></span><span style="display:flex;"><span>Reading /lib/x86_64-linux-gnu/libc.so.6 from remote target...
</span></span></code></pre></div><p>On console GDBSERVER, we now see the following and enter <code>5</code> on prompt.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>$ gdbserver localhost:1234 ./test
</span></span><span style="display:flex;"><span>Process ./test created; pid = 32761
</span></span><span style="display:flex;"><span>Listening on port 1234
</span></span><span style="display:flex;"><span>Remote debugging from host ::1, port 60566
</span></span><span style="display:flex;"><span>Enter the number: 5
</span></span></code></pre></div><p>On console GDB, we now see <code>gdb</code> stopping at break point:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>$ gdb -q
</span></span><span style="display:flex;"><span>(gdb) target remote localhost:1234
</span></span><span style="display:flex;"><span>(gdb) b 7
</span></span><span style="display:flex;"><span>Breakpoint 1 at 0x55555555519c: file test.c, line 7.
</span></span><span style="display:flex;"><span>(gdb) c
</span></span><span style="display:flex;"><span>Continuing.
</span></span><span style="display:flex;"><span>Reading /lib/x86_64-linux-gnu/libc.so.6 from remote target...
</span></span><span style="display:flex;"><span>Breakpoint 1, main () at test.c:7
</span></span></code></pre></div><p>With above, <code>./test</code> is tested with full access to stdin and stdout.</p>
<h2 id="inspect-running-program-via-dap">Inspect running program (via DAP)</h2>
<p>Since Debian/Bookworm 12 currently has GDB 13, we need to follow
&ldquo;<a href="https://github.com/mfussenegger/nvim-dap/wiki/C-C---Rust-(gdb-via--vscode-cpptools)">C C Rust (gdb via vscode cpptools)</a>&rdquo;
using
&ldquo;<a href="https://github.com/Microsoft/vscode-cpptools">github: microsoft/vscode-cpptools</a>&rdquo;.
LazyVim can activate <code>dap.core</code> LazyExtra and activate <code>cpptools </code> in DAP by running <code>:Mason</code> (or <code>&lt;leader&gt;cm</code>).</p>
<p>Next GDB 14 can support <a href="https://microsoft.github.io/debug-adapter-protocol/">DAP (Debug Adapter Protocol)</a> natively.</p>
<p>Problem is Nvim with DAP UI doesn&rsquo;t seem to allow running program using STDIN.</p>
<p>Run <code>./test</code> on a separate console under <code>gdbserver</code> as above solved this
issue for me.</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>I need to read
<code>nvim-dap-ui/doc/nvim-dap-ui.txt</code> and <a href="https://github.com/rcarriga/nvim-dap-ui">nvim-dap-ui/README.md</a> directory since this is not
shown in normal Vim-help system.</p>
<p>Let&rsquo;s check the meaning of DAP-UI.  Following are reordered to match the GUI display by the lua source code of <code>nvim-dap-ui</code> (for icons in <code>repl</code> element):</p>
<ul>
<li>play = &ldquo;&rdquo;       /   pause = &ldquo;&rdquo;</li>
<li>step_into = &ldquo;&rdquo; &ndash; step</li>
<li>step_over = &ldquo;&rdquo; &ndash; next</li>
<li>step_out = &ldquo;&rdquo; &ndash; finish</li>
<li>step_back = &ldquo;&rdquo; &ndash; (PC&ndash;)</li>
<li>run_last = &ldquo;&rdquo; &ndash; (run again)</li>
<li>terminate = &ldquo;&rdquo; &ndash; This one is tricky</li>
<li>disconnect = &ldquo;&rdquo; &ndash; This one is tricky</li>
</ul>
<p>(The above needs font support)</p>
<p>Now I see why debug session terminated when I was playing with icons.  Variable names give me good hints, here.</p>
<p>Setting BP etc., are by keymaps like <code>&lt;leader&gt;db</code> etc. in the main C source display.</p>
<p>As for each meanings of sidebar elements, I guess them as follows from variable names in the <code>layout</code> table:</p>
<ul>
<li><code>left</code> (sidebar)
<ul>
<li><code>scopes</code></li>
<li><code>breakpoints</code></li>
<li><code>stacks</code></li>
<li><code>watches</code></li>
</ul>
</li>
<li><code>bottom</code> (sidebar)
<ul>
<li><code>repl</code></li>
<li><code>console</code></li>
</ul>
</li>
</ul>
<p>Also, I see following keymaps.  These seem to work in left and bottom sidebars. The meaning of these are still vague for me, though.</p>
<ul>
<li>edit = &ldquo;e&rdquo;</li>
<li>expand = <code>{ &quot;&lt;CR&gt;&quot; &quot;&lt;2-LeftMouse&gt;&quot; }</code></li>
<li>open = &ldquo;o&rdquo;</li>
<li>remove = &ldquo;d&rdquo;</li>
<li>repl = &ldquo;r&rdquo;</li>
<li>toggle = &ldquo;t&rdquo;</li>
</ul>
<p>Also UI dialog for &ldquo;Input&rdquo; and &ldquo;Condition&rdquo; needs to be investigated. &hellip;.</p>
<p>After fiddling updates, DAP stops working even with simple <code>hello</code> with direct
<code>gdb</code> run without using <code>gdbserver</code>.  It errors as:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>DAP Couldn&#39;t connect to localhost:${port}: ECONNREFUSED
</span></span></code></pre></div><p>This makes no sense to me.  TBH, it&rsquo;s too complicated and unstable for me at this moment to use this DAP.</p>
<p>Hmmm&hellip; it looks like LazyExtras store data in
<code>~/.config/$NVIM_APPNAME/*.json</code>.  Ensuring to store these updated data in VCS seems to be important.</p>
<p>Let me stick to the basic direct CLI GDB usage for now.</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<h2 id="jump-to-the-specific-position-in-a-file-generic-vim">Jump to the specific position in a file: generic Vim</h2>
<p>Let me revisit trick to jump to the specific position manually.</p>
<p>To go to line 99 of <code>file.txt</code>, try:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>$ vim +99 file.txt
</span></span></code></pre></div><p>To go to line 99 column 40 of <code>file.txt</code>, try any one of the following:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>$ vim +99 file.txt +<span style="color:#e6db74">&#39;norm 40|&#39;</span>
</span></span><span style="display:flex;"><span>$ vim file.txt +<span style="color:#e6db74">&#39;norm 99G40|&#39;</span>
</span></span><span style="display:flex;"><span>$ vim +<span style="color:#e6db74">&#39;call cursor(99, 40)&#39;</span> file.txt
</span></span></code></pre></div><p>NOTE: <code>|</code> (bar) in NORMAL mode is &ldquo;goto column&rdquo;, and in EX-mode is &ldquo;command
separator&rdquo;.
NOTE: Indexing for line and column in Vim starts at 1. <code>0G</code> is for the last
line.  (List index in Vim Script starts at 0.)</p>
<h2 id="my-todo-list">My TODO list</h2>
<ul>
<li>LUA debug
<ul>
<li><a href="https://github.com/jbyuki/one-small-step-for-vimkind">one-small-step-for-vimkind, a.k.a osv</a></li>
<li><a href="https://zignar.net/2023/06/10/debugging-lua-in-neovim/">Debugging Lua in Neovim</a></li>
</ul>
</li>
<li>PYTHON debug
<ul>
<li><a href="https://docs.python.org/3/library/pdb.html">The Python Debugger</a> from python.org</li>
<li><a href="https://github.com/rocky/python3-trepan">python3-trepan</a></li>
</ul>
</li>
<li><a href="https://neovimcraft.com/?search=tag%3Apreconfigured-configuration">Preconfigured setups</a>
<ul>
<li><a href="https://github.com/LazyVim/starter">LazyVim&rsquo;s official starter</a>
<ul>
<li><a href="https://github.com/LazyVim/LazyVim">LazyVim</a> &ndash; <code>lazy.nvim</code> based</li>
<li><a href="https://github.com/folke/lazy.nvim">lazy.nvim</a> &ndash; plugin manager of choice</li>
</ul>
</li>
<li><a href="https://github.com/osamuaoki/starter">osamu&rsquo;s starter with mod based on LazyVim</a></li>
<li><a href="https://github.com/NvChad/starter">NvChad&rsquo;s official starter</a>
<ul>
<li><a href="https://github.com/NvChad/NvChad">NvChad</a> &ndash; <code>lazy.nvim</code> based</li>
</ul>
</li>
<li><a href="https://github.com/AstroNvim/template">AstroNvim&rsquo;s template</a>
<ul>
<li><a href="https://github.com/AstroNvim/AstroNvim">AstroNvim</a> &ndash; <code>lazy.nvim</code> based</li>
</ul>
</li>
<li><a href="https://github.com/nvim-lua/kickstart.nvim">kickstart.nvim</a> &ndash; baseline only</li>
</ul>
</li>
<li><a href="https://github.com/doctorfree/nvim-lazyman">Lazyman Neovim Configuration Manager</a></li>
</ul>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->


<table width="100%">
  <tbody>
  <tr>
  
  <td align="left" width="33%"><a href="/en/2024/06/04/vim-learn-8/">Previous Post</a></td>
  
  <td align="center" width="33%"><a href="/en/">Top</a></td>
  
  <td align="right" width="33%"><a href="#">***</a></td>
  
  </tr>
  </tbody>
</table>

</main>

  <footer>
  
  
  <hr/>
  © 2013-2024 <a href="https://github.com/osamuaoki">Osamu Aoki</a>
  
  </footer>
  </body>
</html>

