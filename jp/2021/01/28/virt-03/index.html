<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>仮想環境(3) | Goofing Osamu</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    
  </head>

  <body>
    <nav>
    <ul class="menu">
      
      <li><a href="/">Home</a></li>
      
      <li><a href="/about/">About</a></li>
      
      <li><a href="/categories/">Categories</a></li>
      
      <li><a href="/tags/">Tags</a></li>
      
      <li><a href="/en/">English</a></li>
      
      <li><a href="/jp/">Japanese</a></li>
      
      <li><a href="/index.xml">Subscribe</a></li>
      
    </ul>
    <hr/>
    </nav>

<div class="article-meta">
<h1><span class="title">仮想環境(3)</span></h1>

<h3 class="date">Date:
2021/01/28 (initial publish),
2021/02/03 (last update)
</h3>
</div>

<main>


<table width="100%">
  <tbody>
  <tr>
  
  <td align="left" width="33%"><a href="/jp/2021/01/27/git-master-main/">Previous Post</a></td>
  
  <td align="center" width="33%"><a href="/jp/">Top</a></td>
  
  <td align="right" width="33%"><a href="#">***</a></td>
  
  </tr>
  </tbody>
</table>

<p>引き続きchrootの強化版のようなLXCを使っての仮想環境作成を深堀りします。</p>
<h2 id="lxc仮想環境の停止">LXC仮想環境の停止</h2>
<p>仮想環境のカスタマイズした起動をするためには、作成し起動した仮想環境の<code>STATE</code>を
<code>STOPPED</code>(停止)に確実にします。</p>
<pre><code>$ sudo lxc-stop -n sid
$ sudo lxc-ls -f
NAME   STATE   AUTOSTART GROUPS IPV4 IPV6 UNPRIVILEGED
buster STOPPED 0         -      -    -    false
sid    STOPPED 0         -      -    -    false
</code></pre><h2 id="lxc仮想環境とのデーター共有起動">LXC仮想環境とのデーター共有起動</h2>
<p>仮想環境のカスタマイズした起動時に、設定変数を指定することで、ホスト側の
<code>/home/fish/src</code>を仮想環境内の<code>/home/fish</code>としてアクセスできるように共有化
された仮想環境として起動できます。この仮想環境環境にユーザーアカウントに
ログインするまでの手順は以下です。</p>
<pre><code>$ sudo lxc-start -n sid \
  -s &quot;lxc.mount.entry=/home/fish/src home/fish none bind 0 0&quot;
$ sudo lxc-attach -n sid
root@sid:/# login
sid login: fish
Password:
 ...
fish@sid:~$
</code></pre><p>ここで仮想環境内のホームディレクトリーで見えるのは<code>/home/fish/src</code>と同一デバイス上の
ファイルだけです。(再帰的マウントはされません。)</p>
<p>このLXC仮想環境内でパッケージビルドなどをすれば綺麗な環境ででき、さらにその結果に
ホスト側から直接アクセスできます。</p>
<p>ここでは、<code>lxc-attach</code>+<code>login</code>でユーザーアカウントに入っていますが、<code>lxc-console</code>を
使っても良いです.</p>
<h2 id="lxc仮想環境とのデーター共有設定">LXC仮想環境とのデーター共有設定</h2>
<p>立ち上げ毎に長い<code>-s</code>オプションを使ってのbindマウント指定をなくするには、<code>lxc-create</code>
コマンドが作った基本の仮想環境の設定ファイル<code>config</code>を編集し、設定します。</p>
<pre><code># cd /var/lib/lxc/sid
# cp config config.orig
# vim config
 ...
# diff -u config.orig config
--- config.orig	2021-01-29 09:34:50.520450872 +0900
+++ config	2021-01-29 00:30:53.868368439 +0900
@@ -13,6 +13,7 @@
 lxc.apparmor.profile = generated
 lxc.apparmor.allow_nesting = 1
 lxc.rootfs.path = dir:/var/lib/lxc/sid/rootfs
+lxc.mount.entry=/home/fish/src/public home/fish/mnt none bind 0 0

 # Common configuration
 lxc.include = /usr/share/lxc/config/debian.common.conf
</code></pre><p>これでホスト側の<code>/home/fish/src</code>を仮想環境内の<code>/home/fish</code>としてアクセス
できるように共有化した仮想環境として立ち上げが、単純な以下の操作でできる
ようになります。</p>
<pre><code>$ sudo lxc-start -n sid
</code></pre><h2 id="使い捨てのlxc仮想環境">使い捨てのLXC仮想環境</h2>
<p><code>pbuilder</code>でコアのシステム環境のコピーをベースにした使い捨ての仮想環境をchrootで準備し
パッケージを作成するように、LXCででもコアのシステム環境のコピーをベースにした使い捨ての
仮想環境を準備してみましょう。</p>
<p>これには、<code>lxc-start</code>に代え<code>lxc-copy</code>を<code>-e</code>フラグとともに使います。(聞きなれない
&ldquo;ephemeral&quot;という表現は「儚い」「束の間であっけない」と言うことです。)</p>
<p><code>lxc-copy</code>には<code>lxc-start</code>の<code>-s</code>オプションのような機能がないので、仮想環境とのデーター
共有を実現するには、コピー元の仮想環境の設定ファイル<code>config</code>を上記のように編集し
<code>lxc.mount.entry</code>を追加設定しておく必要があります。</p>
<pre><code>$ sudo lxc-stop -n sid
$ sudo lxc-info -n sid
Name:           sid
State:          STOPPED
$ sudo lxc-copy -n sid -N sid-dev01 -e
Created sid-dev01 as clone of sid
$ sudo lxc-ls -f
NAME      STATE   AUTOSTART GROUPS IPV4       IPV6 UNPRIVILEGED
buster    STOPPED 0         -      -          -    false
sid       STOPPED 0         -      -          -    false
sid-dev01 RUNNING 0         -      10.0.3.220 -    false
</code></pre><p><code>lxc-copy</code>で使い捨てのLXC仮想環境を起動をするには、実行前にコピー元の仮想環境の<code>STATE</code>を
<code>STOPPED</code>(停止)に確実にする必要があります。</p>
<p>こうして作った使い捨てのLXC仮想環境は、<code>lxc-attach</code>か<code>lxc-console</code>で入り利用できます。</p>
<p>さらに、利用後の使い捨てのLXC仮想環境は、<code>lxc-stop</code>とするだけで<code>lxc-destroy</code>すること無く
消滅するので、開発ホストシステム中のゴミファイルの蓄積を防げます。</p>
<pre><code>$ sudo lxc-stop sid-dev01
$ sudo lxc-ls -f
NAME   STATE   AUTOSTART GROUPS IPV4 IPV6 UNPRIVILEGED
buster STOPPED 0         -      -    -    false
sid    STOPPED 0         -      -    -    false
</code></pre><h2 id="非特権lxc実行環境整備">非特権LXC実行環境整備</h2>
<p>LXC (1:4.0.6-1) をBulleseye環境で<code>/usr/share/doc/lxc/README.Debian</code>の
&ldquo;Unprivileged containers&quot;に従って設定していきます。(2021/02)</p>
<p>まずKERNELがunprivileged user namespacesを有効にしていることを確認します。</p>
<pre><code>$ sudo uname -a
Linux **** 5.10.0-2-amd64 #1 SMP Debian 5.10.9-1 (2021-01-20) x86_64 GNU/Linux
$ sudo sysctl kernel.unprivileged_userns_clone
kernel.unprivileged_userns_clone = 1
</code></pre><p>ユーザーアカウント設定の<code>/etc/subuid</code>と<code>/etc/subgid</code>はすでに設定されていました。</p>
<p>ネットワーク設定は以下を実行：</p>
<pre><code>$ NAME=$(id -un)
$ sudo sh -c &quot;echo $NAME veth lxcbr0 10 &gt;&gt; /etc/lxc/lxc-usernet
</code></pre><p>さらに、<code>~/.config/lxc/default.conf</code>のユーザー設定を<code>/etc/subuid</code>と
<code>/etc/subgid</code>に合わせて以下でします。</p>
<pre><code>$ mkdir -p ~/.config/lxc
$ cat &gt;~/.config/lxc/default.conf &lt;&lt; EOF
lxc.include = /etc/lxc/default.conf
lxc.idmap = u 0 100000 65536
lxc.idmap = g 0 100000 65536
lxc.mount.auto = proc:mixed sys:ro cgroup:mixed
lxc.apparmor.profile = unconfined
EOF
</code></pre><p><code>download</code> templateだけが使えるので実行します。</p>
<pre><code>$ lxc-create -t download -n bullseye-user -- -d debian -r bullseye -a amd64
Setting up the GPG keyring
Downloading the image index
Downloading the rootfs
Downloading the metadata
The image cache is now ready
Unpacking the rootfs

---
You just created a Debian bullseye amd64 (20210203_05:24) container.

To enable SSH, run: apt install openssh-server
No default root or user password are set by LXC.
$ cd ~/.local/share/lxc
$ tree -L 2 .
.
└── bullseye-user
    ├── config
    └── rootfs
$ cd bullseye-user
$ ls -la rootfs
otal 76
drwxr-xr-x  2 100000 100000 4096 Feb  3 14:26 bin
drwxr-xr-x  2 100000 100000 4096 Jul  9  2019 boot
drwxr-xr-x  3 100000 100000 4096 Feb  3 17:08 dev
drwxr-xr-x 41 100000 100000 4096 Feb  3 17:08 etc
drwxr-xr-x  2 100000 100000 4096 Jul  9  2019 home
drwxr-xr-x 10 100000 100000 4096 Feb  3 14:26 lib
drwxr-xr-x  2 100000 100000 4096 Feb  3 14:26 lib64
drwxr-xr-x  2 100000 100000 4096 Feb  3 14:26 media
drwxr-xr-x  2 100000 100000 4096 Feb  3 14:26 mnt
drwxr-xr-x  2 100000 100000 4096 Feb  3 14:26 opt
drwxr-xr-x  2 100000 100000 4096 Jul  9  2019 proc
drwx------  2 100000 100000 4096 Feb  3 14:26 root
drwxr-xr-x  2 100000 100000 4096 Feb  3 14:26 run
drwxr-xr-x  2 100000 100000 4096 Feb  3 14:26 sbin
drwxr-xr-x  2 100000 100000 4096 Feb  3 14:26 srv
drwxr-xr-x  2 100000 100000 4096 Jul  9  2019 sys
drwxrwxrwt  2 100000 100000 4096 Feb  3 14:26 tmp
drwxr-xr-x 11 100000 100000 4096 Feb  3 14:26 usr
drwxr-xr-x 11 100000 100000 4096 Feb  3 14:26 var
</code></pre><p>なるほどUIDやGIDがマップされています。</p>
<p>ここで単純にlxc-startしてもこけますが、<code>README.Debian</code>の指示どおり以下を実行すれば
うまく立ち上がりました。</p>
<pre><code>$ systemd-run --scope --quiet --user --property=Delegate=yes lxc-start -n bullseye-user
$ lxc-ls -f
NAME          STATE   AUTOSTART GROUPS IPV4       IPV6 UNPRIVILEGED
bullseye-user RUNNING 0         -      10.0.3.224 -    true
$ lxc-attach -n bullseye-user
root@bullseye-user:/#
</code></pre><p>GNOME terminal からの実行なので、<code>lxc-attach</code>は<code>systemd-run ...</code>
をつけなくても動きました。</p>
<p>また、非特権LXC仮想環境でも、仮想環境の設定ファイル<code>config</code>を前記の特権LXC
仮想環境と同様に<code>lxc.mount.entry</code>の設定を追加設定することでデーター共有がで
きました。</p>
<h2 id="lxc仮想環境利用のtips">LXC仮想環境利用のTips</h2>
<h3 id="debianパッケージ作成">Debianパッケージ作成</h3>
<p>Debianパッケージ作成に必要なパッケージは正確にはDebian Policyで規定されています。ただ実務的には、
LXCを以下の手順で使うと、ホストシステムをsid環境にして不安定にすることなく作業がはかどります。</p>
<p>まず、ベースとなるsidで作成されたLXC仮想環境に以下のパッケージを導入します。 (前述の手順です)</p>
<ul>
<li><code>build-essential</code></li>
<li><code>devscripts</code></li>
<li><code>debhelper</code></li>
</ul>
<p>さらに、<code>lxc-copy</code>を使い、毎回使い捨てのLXC仮想環境を準備し、その中でホストシステムと
共有されたディレクトリー内に置かれたDebianソースの<code>debian/control</code>に基づき、パッケージビルドに
必要なパッケージを追加導入します。<code>devscripts</code>パッケージに含まれる<code>mk-build-deps</code>コマンドが、
この追加導入操作に便利です。特に<code>-i</code>オプションを使うと便利です。この際、<code>mk-build-deps</code>
実行前に、最新システム環境を確保する<code>apt update; apt full-upgrade</code>を実行する
のが好ましいでしょう。</p>
<p>これなら、<code>pbuilder</code>等の複雑なコマンドを覚えなくとも作業がはかどります。</p>
<h3 id="debianパッケージのデバグ">Debianパッケージのデバグ</h3>
<p>Debianパッケージのデバグの際には、毎回パッケージ依存関係確認のためにインストールするのは
無駄なので、使い捨てではなく必要な全パッケージがインストールされたLXC仮想環境を準備し、
それをベースに<code>lxc-copy</code>を使い、毎回使い捨てのLXC仮想環境を準備した方が効率的です。</p>
<p>PDFファイル作成に<code>texlive-full</code>等の巨大パッケージが利用される際には、この配慮は重要です。</p>
<h3 id="ssh接続">SSH接続</h3>
<p>ホスト側から普通のリモートサーバー同様に操作するには、LXC仮想環境には以下のパッケージを
最低限導入するのがいい。</p>
<ul>
<li>コンテナ上の<code>openssh-server</code>: 公開鍵認証でパスワード無しで接続用に導入・設定します。</li>
<li>コンテナ上の<code>sudo</code>: rootにsshで入れない際にsudoerにユーザーをいれ対応するために導入・設定します。</li>
<li>ホスト上の<code>/etc/hosts</code>: 各LXCのIPにホスト名を定義し、アクセス操作をしやすくする。</li>
</ul>
<h3 id="python2-プログラムの実行">Python2 プログラムの実行</h3>
<p>Debian bullseye 11 以降はPython3のみのサポートとなるので、古いPython2 プログラムを
実行しその動作を確認するには、buster環境で作成されたLXC仮想環境を準備すると便利です。</p>
<h2 id="参考情報">参考情報</h2>
<ul>
<li>Upstream: <a href="https://linuxcontainers.org/">https://linuxcontainers.org/</a></li>
<li>Debian: <code>/usr/share/doc/lxc/README.Debian</code> (最新、重要)</li>
<li>Debian: <a href="https://wiki.debian.org/LXC">https://wiki.debian.org/LXC</a> (slightly outdated docs)</li>
<li>Ubuntu: <a href="https://ubuntu.com/server/docs/containers-lxc">https://ubuntu.com/server/docs/containers-lxc</a> (semi-upstream, recent LXC 4.0)</li>
<li>SUSE: <a href="https://documentation.suse.com/sles/15-SP1/html/SLES-all/part-virt-lxc.html">https://documentation.suse.com/sles/15-SP1/html/SLES-all/part-virt-lxc.html</a>
(16 July 2018)</li>
</ul>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->


<table width="100%">
  <tbody>
  <tr>
  
  <td align="left" width="33%"><a href="/jp/2021/01/27/git-master-main/">Previous Post</a></td>
  
  <td align="center" width="33%"><a href="/jp/">Top</a></td>
  
  <td align="right" width="33%"><a href="#">***</a></td>
  
  </tr>
  </tbody>
</table>

</main>

  <footer>
  
  
  <hr/>
  © 2019-2020 <a href="https://github.com/osamuaoki">Osamu Aoki</a>
  
  </footer>
  </body>
</html>

