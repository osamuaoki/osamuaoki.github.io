<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ATmega328P (1) | Goofing Osamu</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    
  </head>

  <body>
    <nav>
    <ul class="menu">
      
      <li><a href="/">Home</a></li>
      
      <li><a href="/about/">About</a></li>
      
      <li><a href="/categories/">Categories</a></li>
      
      <li><a href="/tags/">Tags</a></li>
      
      <li><a href="/en/">English</a></li>
      
      <li><a href="/jp/">Japanese</a></li>
      
      <li><a href="/index.xml">Subscribe</a></li>
      
    </ul>
    <hr/>
    </nav>

<div class="article-meta">
<h1><span class="title">ATmega328P (1)</span></h1>

<h2 class="date">2020/02/21</h2>
</div>

<main>


<table width="100%">
  <tbody>
  <tr>
  
  <td align="left" width="33%"><a href="/jp/2020/01/03/cg56-1/">Previous Post</a></td>
  
  <td align="center" width="33%"><a href="/jp/">Top</a></td>
  
  <td align="right" width="33%"><a href="#">***</a></td>
  
  </tr>
  </tbody>
</table>



<p>AVRチップのISP経由プログラムの練習をします。これには、
<a href="https://github.com/osamuaoki/avrdude-friend">TTL-232R-5V を使った自作プロクラマー</a>
を使うのも良いのですが、最近Atmel AVR ISP mkIIをただで人からもらったので
それを使います。</p>

<p>ATmega328P は手元にあったブレッドボードに挿せるArduino Nanoのコンパチボードや本物の
Uno等を使ってます。</p>

<h2 id="ソフト環境">ソフト環境</h2>

<pre><code>$ sudo apt install avrdude
</code></pre>

<h2 id="接続">接続</h2>

<p>AVRISP mkIIのVCCは電源電圧監視用でAVRISP mkII側からは電源供給されませんので、
別途チップへの電源供給ソースが必要！Unoなら12V、NanoならUSBを必ずつなぐこと。</p>

<p>不便なのでAVRISP mkIIのUSB 電源 と PIN#1 をつなぎ、電源供給ソースと
する等の改造記事もよくあります。</p>

<ul>
<li><a href="http://www.webx.dk/avrisp-mk2-modding/">http://www.webx.dk/avrisp-mk2-modding/</a> (3V/5V selectable, use own fuse, easy output)</li>
<li><a href="https://jeelabs.org/2010/04/02/avrisp-mkii-w-5v-power/">https://jeelabs.org/2010/04/02/avrisp-mkii-w-5v-power/</a> (nice input after poly fuse)</li>
<li><a href="https://forum.arduino.cc/index.php?topic=125502.0">https://forum.arduino.cc/index.php?topic=125502.0</a> (half ass fix, Nice pics of
wiring, good output point)</li>
<li><a href="https://qiita.com/hideyuki/items/71381b741d89878e3e79">https://qiita.com/hideyuki/items/71381b741d89878e3e79</a> (Easy access via TP1, No fuse)</li>
<li><a href="http://shiozoku.blogspot.com/2014/02/avr-isp-mkii.html">http://shiozoku.blogspot.com/2014/02/avr-isp-mkii.html</a> Use switch (No fuse,
interesting use reminder)</li>
<li><a href="https://electronics.stackexchange.com/questions/286693/can-anything-be-done-about-this-avrisp-mkii-or-is-it-dead">https://electronics.stackexchange.com/questions/286693/can-anything-be-done-about-this-avrisp-mkii-or-is-it-dead</a>
(Nice pics of wiring, not the same purpose, fix by bypassing broken DC/DC)</li>
</ul>

<p>ただし、ターゲットボード側で電源を確保している場合は使えません。</p>

<p>また、これはあとで考えましょう。</p>

<p><a href="https://github.com/osamuaoki/avrdude-friend">TTL-232R-5V を使った自作プロクラマー</a>
は電源電圧供給していた。</p>

<p>ISPケーブルの赤線は１ピン側です。</p>

<h3 id="uno">Uno</h3>

<pre><code>$ sudo avrdude -c avrisp2 -P usb -p m328p -v

avrdude: Version 6.3-20171130
         Copyright (c) 2000-2005 Brian Dean, http://www.bdmicro.com/
         Copyright (c) 2007-2014 Joerg Wunsch

         System wide configuration file is &quot;/etc/avrdude.conf&quot;
         User configuration file is &quot;/root/.avrduderc&quot;
         User configuration file does not exist or is not a regular file, skipping

         Using Port                    : usb
         Using Programmer              : avrisp2
avrdude: usbdev_open(): Found AVRISP mkII, serno: 000200222425
         AVR Part                      : ATmega328P
         Chip Erase delay              : 9000 us
         PAGEL                         : PD7
         BS2                           : PC2
         RESET disposition             : dedicated
         RETRY pulse                   : SCK
         serial program mode           : yes
         parallel program mode         : yes
         Timeout                       : 200
         StabDelay                     : 100
         CmdexeDelay                   : 25
         SyncLoops                     : 32
         ByteDelay                     : 0
         PollIndex                     : 3
         PollValue                     : 0x53
         Memory Detail                 :

                                  Block Poll               Page                       Polled
           Memory Type Mode Delay Size  Indx Paged  Size   Size #Pages MinW  MaxW   ReadBack
           ----------- ---- ----- ----- ---- ------ ------ ---- ------ ----- ----- ---------
           eeprom        65    20     4    0 no       1024    4      0  3600  3600 0xff 0xff
           flash         65     6   128    0 yes     32768  128    256  4500  4500 0xff 0xff
           lfuse          0     0     0    0 no          1    0      0  4500  4500 0x00 0x00
           hfuse          0     0     0    0 no          1    0      0  4500  4500 0x00 0x00
           efuse          0     0     0    0 no          1    0      0  4500  4500 0x00 0x00
           lock           0     0     0    0 no          1    0      0  4500  4500 0x00 0x00
           calibration    0     0     0    0 no          1    0      0     0     0 0x00 0x00
           signature      0     0     0    0 no          3    0      0     0     0 0x00 0x00

         Programmer Type : STK500V2
         Description     : Atmel AVR ISP mkII
         Programmer Model: AVRISP mkII
         Hardware Version: 1
         Firmware Version Master : 1.24
         Vtarget         : 5.1 V
         SCK period      : 8.00 us

avrdude: AVR device initialized and ready to accept instructions

Reading | ################################################## | 100% 0.00s

avrdude: Device signature = 0x1e950f (probably m328p)
avrdude: safemode: lfuse reads as FF
avrdude: safemode: hfuse reads as DE
avrdude: safemode: efuse reads as FD

avrdude: safemode: lfuse reads as FF
avrdude: safemode: hfuse reads as DE
avrdude: safemode: efuse reads as FD
avrdude: safemode: Fuses OK (E:FD, H:DE, L:FF)

avrdude done.  Thank you.

$ sudo avrdude -c avrisp2 -P usb -p m328p -n -F  -U lfuse:r:-:h -U hfuse:r:-:h -U efuse:r:-

avrdude: AVR device initialized and ready to accept instructions

Reading | ################################################## | 100% 0.00s

avrdude: Device signature = 0x1e950f (probably m328p)
avrdude: reading lfuse memory:

Reading | ################################################## | 100% 0.00s

avrdude: writing output file &quot;&lt;stdout&gt;&quot;
0xff
avrdude: reading hfuse memory:

Reading | ################################################## | 100% 0.00s

avrdude: writing output file &quot;&lt;stdout&gt;&quot;
0xde
avrdude: reading efuse memory:

Reading | ################################################## | 100% 0.00s

avrdude: writing output file &quot;&lt;stdout&gt;&quot;

avrdude: safemode: Fuses OK (E:FD, H:DE, L:FF)

avrdude done.  Thank you.
</code></pre>

<h3 id="nano">Nano</h3>

<p>ISP ケーブルが、ボード上をUSB向けに伸びるので挿しにくいので注意。</p>

<pre><code>$ sudo avrdude -c avrisp2 -P usb -p m328p v

avrdude: Version 6.3-20171130
         Copyright (c) 2000-2005 Brian Dean, http://www.bdmicro.com/
         Copyright (c) 2007-2014 Joerg Wunsch

         System wide configuration file is &quot;/etc/avrdude.conf&quot;
         User configuration file is &quot;/root/.avrduderc&quot;
         User configuration file does not exist or is not a regular file, skipping

         Using Port                    : usb
         Using Programmer              : avrisp2
avrdude: usbdev_open(): Found AVRISP mkII, serno: 000200222425
         AVR Part                      : ATmega328P
         Chip Erase delay              : 9000 us
         PAGEL                         : PD7
         BS2                           : PC2
         RESET disposition             : dedicated
         RETRY pulse                   : SCK
         serial program mode           : yes
         parallel program mode         : yes
         Timeout                       : 200
         StabDelay                     : 100
         CmdexeDelay                   : 25
         SyncLoops                     : 32
         ByteDelay                     : 0
         PollIndex                     : 3
         PollValue                     : 0x53
         Memory Detail                 :

                                  Block Poll               Page                       Polled
           Memory Type Mode Delay Size  Indx Paged  Size   Size #Pages MinW  MaxW   ReadBack
           ----------- ---- ----- ----- ---- ------ ------ ---- ------ ----- ----- ---------
           eeprom        65    20     4    0 no       1024    4      0  3600  3600 0xff 0xff
           flash         65     6   128    0 yes     32768  128    256  4500  4500 0xff 0xff
           lfuse          0     0     0    0 no          1    0      0  4500  4500 0x00 0x00
           hfuse          0     0     0    0 no          1    0      0  4500  4500 0x00 0x00
           efuse          0     0     0    0 no          1    0      0  4500  4500 0x00 0x00
           lock           0     0     0    0 no          1    0      0  4500  4500 0x00 0x00
           calibration    0     0     0    0 no          1    0      0     0     0 0x00 0x00
           signature      0     0     0    0 no          3    0      0     0     0 0x00 0x00

         Programmer Type : STK500V2
         Description     : Atmel AVR ISP mkII
         Programmer Model: AVRISP mkII
         Hardware Version: 1
         Firmware Version Master : 1.24
         Vtarget         : 4.8 V
         SCK period      : 8.00 us

avrdude: AVR device initialized and ready to accept instructions

Reading | ################################################## | 100% 0.00s

avrdude: Device signature = 0x1e950f (probably m328p)
avrdude: safemode: lfuse reads as FF
avrdude: safemode: hfuse reads as DA
avrdude: safemode: efuse reads as FD

avrdude: safemode: lfuse reads as FF
avrdude: safemode: hfuse reads as DA
avrdude: safemode: efuse reads as FD
avrdude: safemode: Fuses OK (E:FD, H:DA, L:FF)

avrdude done.  Thank you.

$ sudo avrdude -c avrisp2 -P usb -p m328p -n -F  -U lfuse:r:-:h -U hfuse:r:-:h -U efuse:r:-

avrdude: AVR device initialized and ready to accept instructions

Reading | ################################################## | 100% 0.00s

avrdude: Device signature = 0x1e950f (probably m328p)
avrdude: reading lfuse memory:

Reading | ################################################## | 100% 0.00s

avrdude: writing output file &quot;&lt;stdout&gt;&quot;
0xff
avrdude: reading hfuse memory:

Reading | ################################################## | 100% 0.00s

avrdude: writing output file &quot;&lt;stdout&gt;&quot;
0xda
avrdude: reading efuse memory:

Reading | ################################################## | 100% 0.00s

avrdude: writing output file &quot;&lt;stdout&gt;&quot;

avrdude: safemode: Fuses OK (E:FD, H:DA, L:FF)

avrdude done.  Thank you.

</code></pre>

<h3 id="fuse">Fuse</h3>

<p>なぜかFuseが違います:</p>

<ul>
<li>Uno:  E:FD, H:DE, L:FF

<ul>
<li>SPIEN (Enable Serial programming and Data Downloading) On = 0</li>
</ul></li>
<li>Nano: E:FD, H:DA, L:FF

<ul>
<li>SPIEN (Enable Serial programming and Data Downloading) Off = 1</li>
</ul></li>
</ul>

<p>前に壊したかも知れないので、とりあえずNanoを修正:</p>

<pre><code>$ sudo avrdude -c avrisp2 -P usb -p m328p -F  -U lfuse:w:0xfd:m -U hfuse:w:0xde:m -U efuse:w:0xff:m
</code></pre>

<p>なぜか書き換えられました。</p>

<!-- vim: se ai tw=79: -->


<table width="100%">
  <tbody>
  <tr>
  
  <td align="left" width="33%"><a href="/jp/2020/01/03/cg56-1/">Previous Post</a></td>
  
  <td align="center" width="33%"><a href="/jp/">Top</a></td>
  
  <td align="right" width="33%"><a href="#">***</a></td>
  
  </tr>
  </tbody>
</table>

</main>

  <footer>
  
  
  <hr/>
  &copy; 2019 <a href="https://github.com/osamuaoki">Osamu Aoki</a>
  
  </footer>
  </body>
</html>

